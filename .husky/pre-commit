echo "üîç Running pre-commit checks..."

# Run lint-staged (format and lint changed files)
pnpm lint-staged

# TypeScript type checking for web app
echo "üîç Running TypeScript type check..."
pnpm exec tsc --noEmit --project apps/web/tsconfig.json
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript type check failed!"
  exit 1
fi

# Type safety check (detect 'as any' and other unsafe patterns)
echo "üîç Running type safety check..."
if grep -r "as any" apps/web/src --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "node_modules"; then
  echo "‚ùå Found 'as any' type casts! Please use proper typing instead."
  echo "   See docs/TYPESCRIPT_GUIDELINES.md for guidance."
  exit 1
fi
echo "‚úÖ No prohibited type casts found"

# Validate Firebase hosting rewrites match dynamic routes
echo "üîç Validating Firebase hosting rewrites..."
node scripts/validate-firebase-rewrites.js
if [ $? -ne 0 ]; then
  echo "‚ùå Firebase hosting rewrites validation failed!"
  echo "   Add missing rewrites to firebase.json before the catch-all rule."
  exit 1
fi

# Run pre-deployment checks (skip build and schema for speed)
node scripts/preflight/pre-deployment-check.js --skip-build --skip-schema

# If checks fail, prevent commit
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Pre-commit checks failed. Fix critical issues before committing."
  echo "   To skip this check (not recommended), use: git commit --no-verify"
  exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
