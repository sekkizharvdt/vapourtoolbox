# Codebase Review - December 26, 2025

## Summary

**Overall Grade: B+ (8.2/10)**

The Vapour Toolbox codebase is in good health with strong type safety, comprehensive Firestore security rules, and a well-organized monorepo structure. The application is production-ready with 10 modules deployed. Key strengths include zero type errors, zero lint warnings, and extensive use of transactions for data integrity. Areas for improvement include test coverage (17.6% statement coverage, 40% function coverage) and reducing eslint-disable comments (137 total). A critical bug with `useParams` in static export was identified and fixed during this review period.

---

## Metrics

| Metric                  | Value       | Target | Status |
| ----------------------- | ----------- | ------ | ------ |
| Source Files (web)      | 891         | -      | -      |
| Test Files              | 119         | -      | -      |
| Statement Coverage      | 17.6%       | 60%    | ⚠️     |
| Branch Coverage         | 73.2%       | 80%    | ⚠️     |
| Function Coverage       | 40.3%       | 60%    | ⚠️     |
| Type Errors             | 0           | 0      | ✅     |
| Lint Warnings           | 0           | 0      | ✅     |
| `any` Types             | 7           | 0      | ⚠️     |
| `as any` Assertions     | 0           | 0      | ✅     |
| eslint-disable Comments | 137         | <50    | ⚠️     |
| TODOs                   | 6           | -      | ✅     |
| FIXMEs/HACKs            | 29          | 0      | ⚠️     |
| Firestore Rules         | 1,365 lines | -      | ✅     |
| Firestore Indexes       | 190         | -      | ✅     |
| Cloud Functions         | 16          | -      | ✅     |
| App Routes              | 27          | -      | -      |
| Error Boundaries        | 23          | 27     | ⚠️     |
| Loading States          | 35          | -      | ✅     |

---

## Architecture

### Strengths

- Clean monorepo structure with 6 shared packages
- Well-defined service layer pattern (CRUD/queries/workflow separation)
- Comprehensive Firestore security rules (73 collection matches)
- Good separation of concerns (lib → hooks → components → pages)
- Barrel exports for clean imports

### Concerns

- Static export with Firebase rewrites requires `usePathname` pattern (easy to forget)
- Some large files (>500 lines) in service layer could be split
- 50 lib subdirectories - consider consolidating related modules

### Recommendations

- Document the `usePathname` pattern prominently (done in PATTERNS.md)
- Create a linter rule to warn against `useParams` in dynamic routes
- Consider code splitting for large modules

---

## Code Quality

### Type Safety

- **Excellent**: Zero type errors, strict mode enabled
- **Good**: Only 7 explicit `: any` types in entire codebase
- **Good**: Zero `as any` assertions
- **Issue**: 137 eslint-disable comments, 58 for `react-hooks/exhaustive-deps`

### Error Handling

- Good use of `withErrorHandling` and `withRetry` utilities
- Consistent try/catch patterns in service functions
- 11 `console.log` statements (should be replaced with logger)

### Code Consistency

- Consistent naming conventions across modules
- Good use of shared constants and types
- Some variation in hook patterns between modules

### Documentation

- Code comments are minimal but code is self-documenting
- JSDoc present on key service functions
- New developer docs created (PATTERNS.md, CONTRIBUTING.md)

---

## Security

### Authentication

- ✅ Firebase Auth with Google Sign-In
- ✅ Custom claims synced via Cloud Function
- ✅ Auth state managed in React context

### Authorization

- ✅ Bitwise permission flags (efficient for custom claims)
- ✅ 29 permission checks in service layer
- ✅ Comprehensive Firestore rules (1,365 lines)
- ⚠️ Some service functions don't validate permissions (rely on Firestore rules only)

### Data Validation

- ✅ Zod schemas in `@vapour/validation` package
- ✅ Input validation on forms
- ⚠️ Not all service functions validate input before Firestore write

### Sensitive Data

- ✅ No dangerouslySetInnerHTML usage (comments confirm safe rendering)
- ✅ No hardcoded secrets in codebase
- ✅ Environment variables for Firebase config

---

## Performance

### Bundle Analysis

- Not measured this review (needs production build analysis)
- 27 app routes with dynamic imports should help code splitting

### Database Queries

- ✅ 77 transaction usages for data integrity
- ✅ 190 composite indexes defined
- ⚠️ Some queries may not be paginated (audit needed)

### Memory/Leaks

- 58 `exhaustive-deps` disables may indicate potential memory leaks
- Real-time listeners should be audited for cleanup

### Loading Performance

- 35 loading.tsx files for Suspense boundaries
- 23 error.tsx files for error boundaries
- 4 routes missing error boundaries

---

## Testing

### Unit Test Coverage

| Module      | Test Files | Status      |
| ----------- | ---------- | ----------- |
| Accounting  | 16         | ✅ Good     |
| Procurement | 12         | ⚠️ Medium   |
| Projects    | 6          | ⚠️ Low      |
| Documents   | 5          | ⚠️ Low      |
| BOM         | 5          | ⚠️ Low      |
| Materials   | 3          | ⚠️ Low      |
| HR          | 2          | ❌ Critical |
| Proposals   | 0          | ❌ None     |

### E2E Test Status

- 8 E2E spec files exist
- Playwright configured and working
- Coverage of main user flows needed

### Missing Tests

- HR module has minimal test coverage (2 files for new module)
- Proposals module has zero tests
- Most helper functions lack unit tests

---

## Technical Debt

### TODOs in Code

| Category            | Count | Priority |
| ------------------- | ----- | -------- |
| TODO comments       | 6     | Low      |
| FIXME/HACK comments | 29    | Medium   |
| eslint-disable      | 137   | Medium   |

### Deprecated Patterns

- `useParams` was used incorrectly in 4 files (fixed this review)
- Some older modules use direct Firestore calls instead of service layer

### Workarounds

- 58 `exhaustive-deps` disables indicate dependency array workarounds
- Some type assertions for Firebase Timestamp handling

---

## Module Status

| Module      | Health | Tests | Issues     | Notes                |
| ----------- | ------ | ----- | ---------- | -------------------- |
| Procurement | ✅     | 12    | None       | Production ready     |
| Accounting  | ✅     | 16    | None       | Well tested          |
| Projects    | ✅     | 6     | Minor      | Needs more tests     |
| Materials   | ✅     | 3     | Minor      | Stable               |
| Documents   | ✅     | 5     | Minor      | Stable               |
| Proposals   | ⚠️     | 0     | Tests      | No test coverage     |
| Estimation  | ✅     | 5     | None       | Stable               |
| HR          | ⚠️     | 2     | Tests, New | Beta - needs testing |
| Thermal     | ⚠️     | 0     | Alpha      | Client-side only     |
| Admin       | ✅     | N/A   | None       | Stable               |

---

## Action Items

### Critical (Fix immediately)

None identified.

### High (Fix this sprint)

1. **Add tests for HR module** - New module with minimal coverage
2. **Add tests for Proposals module** - Zero test files
3. **Audit remaining `useParams` usage** - Ensure all dynamic routes use `usePathname`
4. **Add missing error boundaries** - 4 routes without error.tsx

### Medium (Fix this month)

1. **Reduce eslint-disable comments** - 137 total, target <50
2. **Replace console.log with logger** - 11 instances
3. **Audit exhaustive-deps disables** - 58 instances may indicate issues
4. **Add pagination audit** - Ensure all list queries are paginated
5. **Reduce FIXME/HACK comments** - 29 instances

### Low (Backlog)

1. **Add bundle size analysis** - Track JS bundle size
2. **Document remaining patterns** - Query key patterns, mutation patterns
3. **Consider service function permission validation** - Don't rely solely on Firestore rules
4. **Consolidate lib subdirectories** - 50 is high

---

## Completed Since Last Review

This is the first formal review. However, during this review period:

1. ✅ Fixed `useParams` bug in 4 files (TravelExpenseDetailClient, LeaveDetailClient, EditEnquiryClient, EditProposalClient)
2. ✅ Added Firestore rules for hrTravelExpenses collection
3. ✅ Added Firestore indexes for travel expenses
4. ✅ Created documentation structure (README, PATTERNS.md, CONTRIBUTING.md)
5. ✅ Cleaned up 73 scattered documentation files

---

## Notes

- The codebase is production-ready and deployed at https://toolbox.vapourdesal.com
- HR module (leaves, travel expenses) is in beta and actively being developed
- Thermal module is alpha/experimental (calculators only)
- The `usePathname` vs `useParams` issue should be added to onboarding docs
- Consider adding a pre-commit hook to warn about `useParams` in `[id]` directories

---

**Reviewer**: Claude (AI-assisted review)
**Date**: December 26, 2025
**Next Review**: January 2026 (or after major feature completion)
