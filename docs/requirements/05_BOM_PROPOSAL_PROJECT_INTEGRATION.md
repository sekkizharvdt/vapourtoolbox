# BOM â†’ Proposal â†’ Project Integration Requirements

**Document Version**: 1.0
**Created**: November 14, 2025
**Status**: Draft - For Review
**Priority**: ğŸ”´ CRITICAL (Phase 1 - Integration Layer)
**Estimated Effort**: 30-40 hours

---

## 1. Overview

### 1.1 Purpose

This document specifies the integration requirements to create a seamless workflow from engineering estimation to project execution:

```
Material DB + Shape DB â†’ BOM Generator â†’ Proposal Module â†’ Project Module â†’ Procurement Module
                                                                              â†’ Document Management
                                                                              â†’ Tasks Module
```

### 1.2 Business Context

**Current State** (Per user's vision):

- Organization receives enquiry
- Proposal module captures: scope of work, scope of supply, delivery period, estimation, price
- Generate and submit offer to client
- Client awards project
- **GAP**: Manual transfer of data from proposal to project
- **GAP**: BOM not linked to proposal scope of supply
- **GAP**: Procurement items manually created
- **GAP**: Document lists manually created

**Target State**:

- BOM Generator creates detailed equipment/material list with costs
- **One-click transfer**: BOM â†’ Proposal Scope of Supply
- Proposal approved and submitted to client
- Client awards project
- **Automatic transfer**: Proposal â†’ Project with:
  - Budget (from proposal pricing)
  - Procurement items (from BOM items marked as "BUY")
  - Document requirements (from project type and equipment list)
  - Tasks (auto-generated for assigned users)
- **Visibility**: Tasks visible in Tasks module for each user
- **Tracking**: Timeline module shows information flow (Phase 2)

### 1.3 Integration Points

This document covers **3 critical integrations**:

1. **BOM â†’ Proposal Integration** (Section 3)
   - Transfer BOM items to Proposal Scope of Supply
   - Transfer cost breakdown to Proposal Pricing
   - Link BOM to Proposal for updates

2. **Proposal â†’ Project Integration** (Section 4)
   - Create project from accepted proposal
   - Transfer budget and scope
   - Generate procurement items
   - Generate document requirements
   - Auto-create tasks

3. **BOM â†’ Project Integration (Direct)** (Section 5)
   - For projects created without proposal (internal projects)
   - Direct BOM to procurement item mapping

---

## 2. Data Model Extensions

### 2.1 Enhanced Proposal Data Model

Add BOM linking to existing Proposal interface:

```typescript
interface Proposal {
  // ... existing fields ...

  // BOM Integration (NEW)
  bomId?: string; // Link to BOM
  bomCode?: string; // Denormalized BOM code
  bomVersion?: number; // BOM version at time of linking
  bomSyncedAt?: Timestamp; // Last sync from BOM
  bomOutOfSync?: boolean; // True if BOM updated after sync

  // Scope of Supply Enhancement
  scopeOfSupply: ProposalLineItem[]; // Now populated from BOM
}
```

### 2.2 Enhanced ProposalLineItem

Add BOM item linking:

```typescript
interface ProposalLineItem {
  // ... existing fields ...

  // BOM Integration (NEW)
  bomItemId?: string; // Link to BOMItem
  bomItemNumber?: string; // Hierarchical item number (1.1, 1.2.1)
  shapeId?: string; // If from Shape Database
  materialId?: string; // If from Material Database

  // Engineering Data (from BOM)
  weight?: number; // kg (from BOM calculation)
  surfaceArea?: number; // mÂ² (for coating/painting)
  materialGrade?: string; // e.g., "SS 316L", "CS A516 Gr 70"
  standard?: string; // e.g., "ASME B16.9"

  // Cost Breakdown (from BOM)
  costBreakdown?: {
    materialCost?: number; // From BOM material calculation
    fabricationCost?: number; // From BOM fabrication formulas
    overheadCost?: number; // From BOM overhead %
    marginAmount?: number; // From BOM margin %
  };

  // Procurement (from BOM)
  procurementType?: 'MAKE' | 'BUY'; // From BOM item
  leadTime?: number; // Days (from BOM/Material DB)
  preferredVendors?: string[]; // From BOM/Material DB
}
```

### 2.3 Enhanced Project Data Model

Add proposal and BOM linking:

```typescript
interface Project {
  // ... existing fields ...

  // Source Tracking (NEW)
  proposalId?: string; // Link to source Proposal
  proposalNumber?: string; // Denormalized
  bomId?: string; // Link to BOM (via Proposal or direct)
  bomCode?: string; // Denormalized

  // Budget (from Proposal)
  budgetLineItems: BudgetLineItem[]; // Populated from Proposal pricing

  // Procurement Items (from BOM)
  procurementItems: ProjectProcurementItem[]; // Auto-generated from BOM

  // Document Requirements (from Proposal + BOM)
  documentRequirements: DocumentRequirement[]; // Auto-generated

  // Tasks (auto-generated)
  autoGeneratedTasks: string[]; // Task IDs created during project creation
}
```

### 2.4 New: BudgetLineItem

```typescript
interface BudgetLineItem {
  id: string;
  category:
    | 'MATERIAL'
    | 'FABRICATION'
    | 'PROCUREMENT'
    | 'LABOR'
    | 'OVERHEAD'
    | 'CONTINGENCY'
    | 'OTHER';
  description: string;
  budgetedAmount: Money;
  actualAmount?: Money; // Updated as project progresses
  variance?: Money; // budgetedAmount - actualAmount
  variancePercentage?: number; // (variance / budgetedAmount) Ã— 100

  // Source Tracking
  source: 'PROPOSAL' | 'BOM' | 'MANUAL';
  sourceId?: string; // Proposal line item ID or BOM ID
  bomReference?: string; // BOM code if from BOM

  // Status
  locked: boolean; // True if from proposal (cannot edit)

  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### 2.5 New: ProjectProcurementItem

```typescript
interface ProjectProcurementItem {
  id: string;
  itemNumber: string; // Hierarchical (from BOM)

  // Item Details
  description: string;
  specification?: string;
  materialGrade?: string;
  standard?: string; // ASME, ASTM, etc.

  // Quantity
  quantity: number;
  unit: string; // nos, kg, meter, etc.
  weight?: number; // kg (total)

  // Cost
  estimatedUnitCost: Money; // From BOM/Material DB
  estimatedTotalCost: Money; // quantity Ã— estimatedUnitCost

  // Procurement
  procurementType: 'MAKE' | 'BUY';
  leadTime: number; // Days
  preferredVendors: string[]; // Vendor IDs

  // Source Tracking
  bomItemId?: string; // Link to BOM item
  proposalLineItemId?: string; // Link to Proposal line item

  // Status
  status: 'PENDING' | 'PR_CREATED' | 'RFQ_SENT' | 'QUOTED' | 'PO_ISSUED' | 'RECEIVED' | 'CANCELLED';
  purchaseRequestId?: string; // Link to Purchase Request
  purchaseOrderId?: string; // Link to Purchase Order

  // Assignment
  assignedTo?: string; // User responsible for procurement
  requiredByDate?: Timestamp; // Based on project schedule

  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### 2.6 New: DocumentRequirement

```typescript
interface DocumentRequirement {
  id: string;
  documentType: DocumentType;
  description: string;
  reference?: string; // Document number/reference

  // Source
  source: 'PROPOSAL' | 'BOM' | 'PROJECT_TYPE' | 'MANUAL';
  sourceId?: string;

  // Assignment
  assignedTo?: string; // User ID
  assignedToName?: string; // Denormalized
  dueDate?: Timestamp;

  // Status
  status: 'PENDING' | 'IN_PROGRESS' | 'UNDER_REVIEW' | 'APPROVED' | 'SUBMITTED' | 'COMPLETED';
  actualDocumentId?: string; // Link to Document when created

  // Priority
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  isMandatory: boolean; // Required for project completion

  createdAt: Timestamp;
  updatedAt: Timestamp;
}

enum DocumentType {
  // Engineering Documents
  GENERAL_ARRANGEMENT_DRAWING = 'GENERAL_ARRANGEMENT_DRAWING',
  FABRICATION_DRAWING = 'FABRICATION_DRAWING',
  ASSEMBLY_DRAWING = 'ASSEMBLY_DRAWING',
  DETAIL_DRAWING = 'DETAIL_DRAWING',
  PIPING_ISOMETRIC = 'PIPING_ISOMETRIC',
  PID_DIAGRAM = 'PID_DIAGRAM',

  // Calculations
  DESIGN_CALCULATION = 'DESIGN_CALCULATION',
  STRESS_ANALYSIS = 'STRESS_ANALYSIS',
  THERMAL_CALCULATION = 'THERMAL_CALCULATION',

  // Specifications
  TECHNICAL_SPECIFICATION = 'TECHNICAL_SPECIFICATION',
  MATERIAL_SPECIFICATION = 'MATERIAL_SPECIFICATION',
  WELDING_PROCEDURE = 'WELDING_PROCEDURE',

  // Quality Documents
  MATERIAL_TEST_CERTIFICATE = 'MATERIAL_TEST_CERTIFICATE',
  WELDING_TEST_REPORT = 'WELDING_TEST_REPORT',
  NDT_REPORT = 'NDT_REPORT',
  HYDRO_TEST_REPORT = 'HYDRO_TEST_REPORT',

  // Certification
  DESIGN_CERTIFICATE = 'DESIGN_CERTIFICATE',
  MANUFACTURERS_DATA_REPORT = 'MANUFACTURERS_DATA_REPORT',

  // Client Deliverables
  OPERATION_MANUAL = 'OPERATION_MANUAL',
  MAINTENANCE_MANUAL = 'MAINTENANCE_MANUAL',
  AS_BUILT_DRAWING = 'AS_BUILT_DRAWING',

  // Other
  OTHER = 'OTHER',
}
```

---

## 3. Integration 1: BOM â†’ Proposal

### 3.1 Use Case: Add BOM to Proposal

**Actor**: User with CREATE_PROPOSAL and VIEW_BOM permissions

**Preconditions**:

- BOM exists with status = APPROVED or RELEASED
- Proposal exists with status = DRAFT or PENDING_APPROVAL

**Flow**:

1. **User navigates to Proposal Editor**
2. **Click "Import from BOM"** button in Scope of Supply section
3. **BOM Selection Dialog opens**:
   - Search/filter BOMs by:
     - BOM code
     - Category (Heat Exchanger, Pressure Vessel, etc.)
     - Status (APPROVED, RELEASED)
     - Date range
   - Display BOM preview:
     - BOM code, name, category
     - Total weight, total cost
     - Item count
     - Last updated date

4. **User selects BOM**
5. **BOM Item Selection Dialog**:
   - Show hierarchical tree of BOM items
   - Checkboxes to select which items to import
   - Options:
     - â˜‘ Import all items
     - â˜‘ Import only top-level assemblies (hide sub-items)
     - â˜‘ Import only "BUY" items (exclude "MAKE" items)
     - â˜‘ Group by assembly
   - Show cost totals for selected items

6. **User configures import settings**:
   - **Include cost breakdown?**: Yes/No (if No, hide material/fabrication costs)
   - **Apply markup?**: Percentage field (default from proposal settings)
   - **Pricing strategy**:
     - â—‰ Show individual item prices
     - â—‰ Show assembly-level prices only
     - â—‰ Show single lump-sum price
   - **Technical detail level**:
     - â—‰ Full specification (material grade, standard, dimensions)
     - â—‰ Summary specification (name and key parameters only)
     - â—‰ Description only (no technical details)

7. **System processes import**:

   ```typescript
   For each selected BOM item:
     1. Create ProposalLineItem:
        - itemNumber = BOMItem.itemNumber
        - itemName = BOMItem.name
        - description = Generate from BOMItem + Shape + Material
        - quantity = BOMItem.quantity
        - unit = BOMItem.unit
        - weight = BOMItem.calculatedProperties.totalWeight
        - materialGrade = Material.specification.grade
        - standard = Shape.standard.code

     2. Calculate pricing:
        - unitPrice = BOMItem.cost.itemTotal / BOMItem.quantity
        - Apply markup: unitPrice = unitPrice Ã— (1 + markup%)
        - totalPrice = unitPrice Ã— quantity

     3. Cost breakdown (if enabled):
        - materialCost = BOMItem.cost.materialCostTotal
        - fabricationCost = BOMItem.cost.fabricationCostTotal
        - Apply markup to each component

     4. Procurement data:
        - procurementType = BOMItem.procurement.procurementType
        - leadTime = BOMItem.procurement.leadTime
        - preferredVendors = BOMItem.procurement.preferredVendors

     5. Create link:
        - ProposalLineItem.bomItemId = BOMItem.id
        - ProposalLineItem.bomItemNumber = BOMItem.itemNumber
   ```

8. **System creates proposal line items**
9. **System calculates pricing totals**:
   - Subtotal = SUM(all line item totalPrice)
   - Apply proposal-level overhead (if configured)
   - Apply taxes (GST)
   - Calculate total amount

10. **System creates BOM link**:
    - Proposal.bomId = BOM.id
    - Proposal.bomCode = BOM.bomCode
    - Proposal.bomVersion = BOM.version
    - Proposal.bomSyncedAt = NOW()
    - Proposal.bomOutOfSync = false

11. **Display confirmation**:
    - "âœ“ Imported 24 items from BOM-2025-0042"
    - Show summary table:
      - Total items: 24
      - Total weight: 3,600 kg
      - Material cost: â‚¹9,10,000
      - Fabrication cost: â‚¹4,50,000
      - Markup (15%): â‚¹2,04,000
      - Subtotal: â‚¹15,64,000

12. **User reviews and edits** (optional):
    - Can edit quantities, prices
    - Can add/remove items
    - Can reorder items
    - Can group items into sections

**Validations**:

- BOM status must be APPROVED or RELEASED
- BOM cannot be empty (must have at least 1 item)
- If proposal already has line items, warn: "This will replace existing items. Continue?"
- Markup percentage: 0-200%

**Outputs**:

- Proposal.scopeOfSupply populated with BOM items
- Proposal.pricing updated with calculated totals
- BOM linked to Proposal
- Audit log: "BOM BOM-2025-0042 imported to Proposal PROP-2025-0123"

### 3.2 Use Case: Sync BOM Updates to Proposal

**Trigger**: BOM updated after linking to Proposal

**Flow**:

1. **BOM updated** (quantity changed, item added, cost recalculated)
2. **System sets** `Proposal.bomOutOfSync = true`
3. **User opens Proposal**
4. **System displays warning banner**:

   ```
   âš ï¸ BOM BOM-2025-0042 has been updated since last sync.
   Last synced: Nov 14, 2025 10:30 AM
   BOM last updated: Nov 14, 2025 2:45 PM
   [View Changes] [Sync Now] [Ignore]
   ```

5. **User clicks "View Changes"**:
   - Show diff view:
     - Items added (green)
     - Items removed (red)
     - Items modified (yellow)
     - Quantity changes
     - Cost changes
   - Show impact on total price

6. **User clicks "Sync Now"**:
   - Options:
     - â—‰ Replace all items (destructive)
     - â—‰ Update existing items only (safe)
     - â—‰ Selective sync (choose which items to update)

7. **System performs sync**
8. **Update** `Proposal.bomSyncedAt = NOW()`
9. **Set** `Proposal.bomOutOfSync = false`

**Edge Cases**:

- If Proposal status = SUBMITTED or ACCEPTED, prevent sync (warn: "Create new revision")
- If user manually edited prices, warn: "Manual changes will be overwritten"

### 3.3 BOM Item â†’ Proposal Line Item Mapping

**Detailed Specification Formatting Examples**:

**Example 1: Cylindrical Shell (Shape-based)**

```
BOM Item:
  itemNumber: "1.1"
  name: "Cylindrical Shell"
  shapeId: "SHP-2025-0012" (SHELL_CYLINDRICAL)
  materialId: "MAT-2025-0045" (CS A516 Gr 70)
  parameters: { Di: 1000, L: 3000, t: 10 }
  weight: 2450 kg
  cost: { materialCost: 245000, fabricationCost: 150000, itemTotal: 395000 }

Proposal Line Item (Full Specification):
  itemNumber: "1.1"
  itemName: "Cylindrical Shell"
  description: "Cylindrical shell, CS A516 Gr 70, ID 1000 mm Ã— Length 3000 mm Ã— Thickness 10 mm. Weight: 2,450 kg. As per ASME Section VIII Div 1, UG-27."
  technicalSpecification: "Material: Carbon Steel ASTM A516 Grade 70
                           Inside Diameter: 1000 mm
                           Length: 3000 mm (straight length)
                           Thickness: 10 mm
                           Standard: ASME Section VIII Division 1, UG-27
                           Weight: 2,450 kg"
  quantity: 1
  unit: "nos"
  weight: 2450
  materialGrade: "A516 Gr 70"
  standard: "ASME Section VIII Div 1, UG-27"
  unitPrice: â‚¹395,000 (no markup) or â‚¹454,250 (with 15% markup)
  totalPrice: â‚¹454,250
  costBreakdown: {
    materialCost: 245000,
    fabricationCost: 150000,
    marginAmount: 59250
  }
  procurementType: "MAKE"
```

**Example 2: Standard Bought-out Item (Fitting)**

```
BOM Item:
  itemNumber: "3.1"
  name: "Elbow 90Â° LR"
  specification: "Elbow 90Â° Long Radius, 6â€³ Sch 40, ASME B16.9, SS 316L"
  materialId: "MAT-2025-0089" (Fittings Butt Weld SS)
  quantity: 4
  weight: 12 kg (total)
  cost: { materialCost: 24000, itemTotal: 24000 }

Proposal Line Item (Summary Specification):
  itemNumber: "3.1"
  itemName: "Elbow 90Â° LR 6â€³ Sch 40 316L"
  description: "Butt weld elbow 90Â° long radius, 6â€³ NPS Schedule 40, Stainless Steel 316L. As per ASME B16.9. Quantity: 4 nos."
  quantity: 4
  unit: "nos"
  weight: 12
  materialGrade: "SS 316L"
  standard: "ASME B16.9"
  unitPrice: â‚¹6,000 (base) or â‚¹6,900 (with 15% markup)
  totalPrice: â‚¹27,600
  procurementType: "BUY"
  preferredVendors: ["VEN-2025-0042", "VEN-2025-0087"]
  leadTime: 30
```

**Example 3: Lump-sum Assembly**

```
BOM Items:
  2. Tube Bundle (assembly)
    2.1 Tubes (100 nos)
    2.2 Tie Rods (6 nos)
    2.3 Spacers (20 nos)
  Total cost: â‚¹2,55,000

Proposal Line Item (Lump-sum):
  itemNumber: "2"
  itemName: "Tube Bundle Assembly"
  description: "Complete tube bundle assembly comprising 100 nos SS 316L tubes (OD 25.4 mm, Length 2900 mm), 6 nos tie rods, and 20 nos spacers. Total weight: 850 kg."
  quantity: 1
  unit: "lot"
  weight: 850
  totalPrice: â‚¹2,93,250 (with 15% markup)
  procurementType: "MAKE"
  notes: "Includes all sub-components as per BOM BOM-2025-0042"
```

### 3.4 UI/UX: BOM Import Dialog

**Mockup**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Import from BOM                                                    [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 1: Select BOM                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Search: [Search BOM by code or name...                       ] [Search] â”‚
â”‚                                                                          â”‚
â”‚ Filter: [Category: All â–¼] [Status: Approved/Released â–¼]                â”‚
â”‚                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ â—¯ BOM-2025-0042  Heat Exchanger HX-101                           â”‚   â”‚
â”‚ â”‚    Category: HEAT_EXCHANGER â”‚ Status: APPROVED â”‚ Items: 24      â”‚   â”‚
â”‚ â”‚    Weight: 3,600 kg â”‚ Cost: â‚¹13,60,000 â”‚ Updated: Nov 14, 2025  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â—¯ BOM-2025-0041  Pressure Vessel PV-201                          â”‚   â”‚
â”‚ â”‚    Category: PRESSURE_VESSEL â”‚ Status: RELEASED â”‚ Items: 18     â”‚   â”‚
â”‚ â”‚    Weight: 5,200 kg â”‚ Cost: â‚¹18,75,000 â”‚ Updated: Nov 12, 2025  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚                                          [Cancel] [Next: Select Items]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Import from BOM: BOM-2025-0042                                     [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: Select Items                                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Quick Selection: [â˜‘ Select All] [â˜ Top-level only] [â˜ BUY items only] â”‚
â”‚                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ â˜‘ 1. Shell Assembly (â‚¹5,20,000)                                  â”‚   â”‚
â”‚ â”‚   â˜‘ 1.1 Cylindrical Shell (â‚¹2,50,000)                            â”‚   â”‚
â”‚ â”‚   â˜‘ 1.2 Front Tube Sheet (â‚¹87,500)                               â”‚   â”‚
â”‚ â”‚   â˜‘ 1.3 Rear Tube Sheet (â‚¹87,500)                                â”‚   â”‚
â”‚ â”‚   â˜‘ 1.4 Front Head (â‚¹62,500)                                     â”‚   â”‚
â”‚ â”‚   â˜‘ 1.5 Rear Head (â‚¹62,500)                                      â”‚   â”‚
â”‚ â”‚ â˜‘ 2. Tube Bundle (â‚¹2,55,000)                                     â”‚   â”‚
â”‚ â”‚   â˜‘ 2.1 Tubes (100 nos) (â‚¹2,40,000)                              â”‚   â”‚
â”‚ â”‚   â˜‘ 2.2 Tie Rods (6 nos) (â‚¹15,000)                               â”‚   â”‚
â”‚ â”‚ â˜‘ 3. Nozzles (â‚¹90,000)                                           â”‚   â”‚
â”‚ â”‚   â˜‘ 3.1 Shell Inlet (â‚¹25,000)                                    â”‚   â”‚
â”‚ â”‚   â˜‘ 3.2 Shell Outlet (â‚¹25,000)                                   â”‚   â”‚
â”‚ â”‚   â˜‘ 3.3 Tube Inlet (â‚¹20,000)                                     â”‚   â”‚
â”‚ â”‚   â˜‘ 3.4 Tube Outlet (â‚¹20,000)                                    â”‚   â”‚
â”‚ â”‚ â˜‘ 4. Supports (â‚¹45,000)                                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚ Selected: 16 items â”‚ Total Weight: 3,600 kg â”‚ Total Cost: â‚¹9,10,000   â”‚
â”‚                                                                          â”‚
â”‚                                    [< Back] [Cancel] [Next: Configure]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Import from BOM: BOM-2025-0042                                     [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: Configure Import                                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Pricing:                                                                â”‚
â”‚   Markup Percentage: [15      ] %                                      â”‚
â”‚   â˜‘ Include cost breakdown (material, fabrication)                     â”‚
â”‚                                                                          â”‚
â”‚ Pricing Display:                                                        â”‚
â”‚   â—‰ Show individual item prices                                        â”‚
â”‚   â—‹ Show assembly-level prices only                                    â”‚
â”‚   â—‹ Show single lump-sum price                                         â”‚
â”‚                                                                          â”‚
â”‚ Technical Detail Level:                                                 â”‚
â”‚   â—‰ Full specification (material grade, dimensions, standards)         â”‚
â”‚   â—‹ Summary specification (key parameters only)                        â”‚
â”‚   â—‹ Description only (no technical details)                            â”‚
â”‚                                                                          â”‚
â”‚ Preview:                                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 1.1 Cylindrical Shell                                             â”‚   â”‚
â”‚ â”‚ Cylindrical shell, CS A516 Gr 70, ID 1000 mm Ã— Length 3000 mm    â”‚   â”‚
â”‚ â”‚ Ã— Thickness 10 mm. Weight: 2,450 kg. As per ASME Section VIII.   â”‚   â”‚
â”‚ â”‚ Quantity: 1 nos â”‚ Unit Price: â‚¹2,87,500 â”‚ Total: â‚¹2,87,500       â”‚   â”‚
â”‚ â”‚ Cost Breakdown: Material â‚¹2,45,000 + Fabrication â‚¹42,500         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚ Summary:                                                                â”‚
â”‚   Base Cost: â‚¹9,10,000                                                 â”‚
â”‚   Markup (15%): â‚¹1,36,500                                              â”‚
â”‚   Subtotal: â‚¹10,46,500                                                 â”‚
â”‚                                                                          â”‚
â”‚                                    [< Back] [Cancel] [Import to Proposal]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Integration 2: Proposal â†’ Project

### 4.1 Use Case: Create Project from Accepted Proposal

**Actor**: User with CREATE_PROJECT permission

**Trigger**: Proposal status changed to ACCEPTED

**Flow**:

1. **User updates Proposal status to ACCEPTED**
   - Enter acceptance date
   - Enter client PO number
   - Enter client PO value (if different from proposal amount)

2. **System displays "Create Project" dialog**:

   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Create Project from Proposal                                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Proposal: PROP-2025-0123                                    â”‚
   â”‚ Client: ABC Industries Pvt Ltd                              â”‚
   â”‚ Value: â‚¹15,81,250                                           â”‚
   â”‚                                                              â”‚
   â”‚ Project Details:                                             â”‚
   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
   â”‚ Project Name: [Heat Exchanger HX-101 Supply              ] â”‚
   â”‚ Project Code: [PRJ-2025-    ] (auto-generated)             â”‚
   â”‚ Start Date:   [Nov 15, 2025] (default: today)              â”‚
   â”‚ Target Completion: [Feb 15, 2026] (from proposal: 12 weeks)â”‚
   â”‚                                                              â”‚
   â”‚ Project Manager: [Select User â–¼]                            â”‚
   â”‚                                                              â”‚
   â”‚ What to transfer:                                            â”‚
   â”‚ â˜‘ Budget (from proposal pricing)                            â”‚
   â”‚ â˜‘ Procurement items (from BOM "BUY" items)                  â”‚
   â”‚ â˜‘ Document requirements                                     â”‚
   â”‚ â˜‘ Auto-create tasks                                         â”‚
   â”‚ â˜‘ Link BOM to project                                       â”‚
   â”‚                                                              â”‚
   â”‚ Preview:                                                     â”‚
   â”‚ - Budget line items: 4                                       â”‚
   â”‚ - Procurement items to create: 12                            â”‚
   â”‚ - Document requirements: 8                                   â”‚
   â”‚ - Tasks to create: 15                                        â”‚
   â”‚                                                              â”‚
   â”‚                              [Cancel] [Create Project]       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **User clicks "Create Project"**

4. **System creates Project**:

   ```typescript
   const project: Project = {
     id: generateId(),
     projectCode: generateProjectCode(), // PRJ-2025-NNNN
     name: proposalTitle,
     description: proposal.scopeOfWork.summary,

     // Client info
     clientId: proposal.clientId,
     clientName: proposal.clientName,
     clientContactPerson: proposal.clientContactPerson,

     // Dates
     startDate: selectedStartDate,
     targetCompletionDate: calculateTargetDate(startDate, proposal.deliveryPeriod.durationInWeeks),

     // Financial
     contractValue: proposal.pricing.totalAmount,
     clientPONumber: clientPONumber,
     clientPODate: acceptanceDate,

     // Links
     proposalId: proposal.id,
     proposalNumber: proposal.proposalNumber,
     bomId: proposal.bomId,
     bomCode: proposal.bomCode,

     // Team
     projectManagerId: selectedPM,

     // Status
     status: 'PLANNING',

     createdAt: NOW(),
     createdBy: currentUser.id,
   };
   ```

5. **System creates Budget Line Items**:

   ```typescript
   // From Proposal Pricing
   for (const priceItem of proposal.pricing.lineItems) {
     const budgetItem: BudgetLineItem = {
       id: generateId(),
       category: priceItem.category,
       description: priceItem.description,
       budgetedAmount: priceItem.amount,
       source: 'PROPOSAL',
       sourceId: priceItem.id,
       locked: true, // Cannot edit (from proposal)
       createdAt: NOW(),
     };

     await createBudgetLineItem(project.id, budgetItem);
   }

   // If BOM linked, create BOM-based budget items
   if (proposal.bomId) {
     const bom = await getBOMById(proposal.bomId);

     // Material budget
     await createBudgetLineItem(project.id, {
       category: 'MATERIAL',
       description: 'Raw Materials (from BOM)',
       budgetedAmount: bom.summary.totalMaterialCost,
       source: 'BOM',
       sourceId: bom.id,
       bomReference: bom.bomCode,
       locked: true,
     });

     // Fabrication budget
     await createBudgetLineItem(project.id, {
       category: 'FABRICATION',
       description: 'Fabrication & Assembly (from BOM)',
       budgetedAmount: bom.summary.totalFabricationCost,
       source: 'BOM',
       sourceId: bom.id,
       bomReference: bom.bomCode,
       locked: true,
     });
   }
   ```

6. **System creates Procurement Items**:

   ```typescript
   if (proposal.bomId) {
     const bomItems = await getBOMItems(proposal.bomId);

     // Filter only BUY items
     const buyItems = bomItems.filter((item) => item.procurement?.procurementType === 'BUY');

     for (const bomItem of buyItems) {
       const procurementItem: ProjectProcurementItem = {
         id: generateId(),
         itemNumber: bomItem.itemNumber,
         description: bomItem.name,
         specification: formatSpecification(bomItem),
         materialGrade: getMaterialGrade(bomItem.component?.materialId),
         standard: getStandard(bomItem.component?.shapeId),

         quantity: bomItem.quantity,
         unit: bomItem.unit,
         weight: bomItem.calculatedProperties?.totalWeight,

         estimatedUnitCost: bomItem.cost?.materialCost,
         estimatedTotalCost: bomItem.cost?.materialCostTotal,

         procurementType: 'BUY',
         leadTime: bomItem.procurement.leadTime,
         preferredVendors: bomItem.procurement.preferredVendors,

         bomItemId: bomItem.id,

         status: 'PENDING',
         requiredByDate: calculateRequiredDate(project.startDate, bomItem.procurement.leadTime),

         createdAt: NOW(),
       };

       await createProcurementItem(project.id, procurementItem);
     }
   }
   ```

7. **System creates Document Requirements**:

   ```typescript
   // Based on project type and BOM
   const docRequirements: DocumentRequirement[] = [];

   // Standard engineering documents
   docRequirements.push({
     documentType: 'GENERAL_ARRANGEMENT_DRAWING',
     description: 'General Arrangement Drawing for ' + project.name,
     source: 'PROJECT_TYPE',
     assignedTo: findUserWithPermission('CREATE_ENGINEERING_DOCUMENT'),
     dueDate: addDays(project.startDate, 14),
     status: 'PENDING',
     priority: 'HIGH',
     isMandatory: true,
   });

   // Fabrication drawings for each MAKE item
   if (proposal.bomId) {
     const makeItems = bomItems.filter(
       (item) => item.procurement?.procurementType === 'MAKE' && item.itemType === 'ASSEMBLY'
     );

     for (const makeItem of makeItems) {
       docRequirements.push({
         documentType: 'FABRICATION_DRAWING',
         description: `Fabrication Drawing: ${makeItem.name}`,
         reference: `DRG-${project.projectCode}-${makeItem.itemNumber}`,
         source: 'BOM',
         sourceId: makeItem.id,
         assignedTo: findUserWithPermission('CREATE_ENGINEERING_DOCUMENT'),
         dueDate: addDays(project.startDate, 21),
         status: 'PENDING',
         priority: 'HIGH',
         isMandatory: true,
       });
     }
   }

   // Calculation documents (if pressure vessel)
   if (bomCategory === 'PRESSURE_VESSEL' || bomCategory === 'HEAT_EXCHANGER') {
     docRequirements.push({
       documentType: 'DESIGN_CALCULATION',
       description: 'Design Calculation as per ASME Section VIII',
       source: 'PROJECT_TYPE',
       assignedTo: findUserWithPermission('CREATE_ENGINEERING_DOCUMENT'),
       dueDate: addDays(project.startDate, 14),
       priority: 'CRITICAL',
       isMandatory: true,
     });
   }

   // Quality documents
   docRequirements.push({
     documentType: 'MATERIAL_TEST_CERTIFICATE',
     description: 'Material Test Certificates (Mill Certificates)',
     source: 'PROJECT_TYPE',
     dueDate: addDays(project.targetCompletionDate, -14),
     priority: 'HIGH',
     isMandatory: true,
   });

   // Client deliverables (from proposal terms)
   docRequirements.push({
     documentType: 'OPERATION_MANUAL',
     description: 'Operation & Maintenance Manual',
     source: 'PROPOSAL',
     dueDate: project.targetCompletionDate,
     priority: 'HIGH',
     isMandatory: true,
   });

   docRequirements.push({
     documentType: 'AS_BUILT_DRAWING',
     description: 'As-Built Drawings (complete set)',
     source: 'PROPOSAL',
     dueDate: project.targetCompletionDate,
     priority: 'MEDIUM',
     isMandatory: true,
   });

   // Create all document requirements
   for (const docReq of docRequirements) {
     await createDocumentRequirement(project.id, docReq);
   }
   ```

8. **System creates Tasks**:

   ```typescript
   const tasks: Task[] = [];

   // Task 1: Project Kickoff
   tasks.push({
     title: `Project Kickoff: ${project.name}`,
     description: 'Conduct project kickoff meeting with team',
     assignedTo: project.projectManagerId,
     dueDate: addDays(project.startDate, 3),
     priority: 'HIGH',
     status: 'PENDING',
     projectId: project.id,
   });

   // Task 2: Material Procurement (for each procurement item)
   const procurementItems = await getProjectProcurementItems(project.id);
   const procurementLead = findUserWithPermission('CREATE_PURCHASE_REQUEST');

   tasks.push({
     title: `Procure Materials: ${procurementItems.length} items`,
     description: `Create purchase requests for all procurement items from BOM ${proposal.bomCode}`,
     assignedTo: procurementLead,
     dueDate: addDays(project.startDate, 7),
     priority: 'HIGH',
     status: 'PENDING',
     projectId: project.id,
   });

   // Task 3: Engineering Documents (for each document requirement)
   const engineeringDocs = docRequirements.filter(
     (d) => d.documentType.includes('DRAWING') || d.documentType.includes('CALCULATION')
   );

   for (const doc of engineeringDocs) {
     tasks.push({
       title: `Create ${doc.documentType}`,
       description: doc.description,
       assignedTo: doc.assignedTo,
       dueDate: doc.dueDate,
       priority: doc.priority,
       status: 'PENDING',
       projectId: project.id,
       linkedDocumentRequirement: doc.id,
     });
   }

   // Task 4: Quality Inspection Planning
   tasks.push({
     title: 'Prepare Quality Inspection Plan',
     description: 'Create inspection and test plan (ITP) for all fabrication activities',
     assignedTo: findUserWithPermission('MANAGE_QUALITY'),
     dueDate: addDays(project.startDate, 14),
     priority: 'MEDIUM',
     status: 'PENDING',
     projectId: project.id,
   });

   // Create all tasks
   for (const task of tasks) {
     const createdTask = await createTask(task);
     project.autoGeneratedTasks.push(createdTask.id);
   }
   ```

9. **System updates Proposal**:

   ```typescript
   await updateProposal(proposal.id, {
     projectId: project.id,
     projectNumber: project.projectCode,
     status: 'ACCEPTED', // Already set, but ensure consistency
   });
   ```

10. **System sends notifications**:

    ```typescript
    // Notify Project Manager
    await sendNotification({
      userId: project.projectManagerId,
      type: 'PROJECT_CREATED',
      title: `New Project Assigned: ${project.name}`,
      message: `Project ${project.projectCode} has been created from Proposal ${proposal.proposalNumber}. 15 tasks have been assigned.`,
      link: `/projects/${project.id}`,
    });

    // Notify all users with assigned tasks
    for (const task of tasks) {
      if (task.assignedTo !== project.projectManagerId) {
        await sendNotification({
          userId: task.assignedTo,
          type: 'TASK_ASSIGNED',
          title: `New Task: ${task.title}`,
          message: `You have been assigned a task for project ${project.projectCode}`,
          link: `/tasks/${task.id}`,
        });
      }
    }

    // Notify procurement team
    await sendNotification({
      role: 'PROCUREMENT',
      type: 'PROCUREMENT_ITEMS_READY',
      title: `Procurement Items Ready: ${project.name}`,
      message: `${procurementItems.length} items ready for procurement in project ${project.projectCode}`,
      link: `/projects/${project.id}/procurement`,
    });
    ```

11. **Display success message**:

    ```
    âœ“ Project PRJ-2025-0089 created successfully!

    Summary:
    - Budget line items: 4 (Total: â‚¹15,81,250)
    - Procurement items: 12 (Total value: â‚¹3,50,000)
    - Document requirements: 8 (7 mandatory)
    - Tasks created: 15 (assigned to 4 users)

    [View Project] [View Tasks] [View Procurement Items]
    ```

**Validations**:

- Proposal status must be ACCEPTED
- Project Manager must be selected
- Start date cannot be in the past
- Target completion date must be after start date

**Outputs**:

- Project created with all data transferred
- Budget line items created (locked from proposal)
- Procurement items created (from BOM BUY items)
- Document requirements created (8-15 items)
- Tasks created (10-20 tasks)
- Notifications sent to all assigned users
- Proposal linked to Project

### 4.2 Automatic Task Generation Rules

**Rule-based Task Creation**:

| Trigger Condition                  | Task Generated                  | Assigned To        | Due Date                | Priority |
| ---------------------------------- | ------------------------------- | ------------------ | ----------------------- | -------- |
| Project created from proposal      | Project Kickoff Meeting         | Project Manager    | Start + 3 days          | HIGH     |
| BOM contains "BUY" items           | Procure Materials               | Procurement Lead   | Start + 7 days          | HIGH     |
| Document requirement: DRAWING      | Create [Drawing Type]           | Engineering Lead   | From doc requirement    | HIGH     |
| Document requirement: CALCULATION  | Perform Design Calculation      | Engineering Lead   | Start + 14 days         | CRITICAL |
| BOM contains MAKE items (assembly) | Create Fabrication Plan         | Production Manager | Start + 14 days         | MEDIUM   |
| Pressure vessel category           | Prepare Quality Inspection Plan | QA/QC Manager      | Start + 14 days         | HIGH     |
| Project type: SUPPLY_AND_INSTALL   | Plan Site Installation          | Project Manager    | 80% of project duration | MEDIUM   |
| Proposal has warranty terms        | Create Warranty Tracking        | Project Manager    | Completion - 7 days     | LOW      |
| Client deliverable: MANUAL         | Prepare O&M Manual              | Technical Writer   | Completion - 14 days    | MEDIUM   |
| Project completion date set        | Final Inspection & Testing      | QA/QC Manager      | Completion - 7 days     | HIGH     |

**Task Dependencies**:

```
Kickoff Meeting â†’ Material Procurement â†’ Fabrication â†’ Inspection â†’ Delivery
                â†’ Engineering Drawings â†’ Fabrication
                â†’ Quality Plan â†’ Inspection
```

---

## 5. Integration 3: BOM â†’ Project (Direct)

### 5.1 Use Case: Create Project from BOM (No Proposal)

**Scenario**: Internal projects, R&D, or projects that skip the proposal stage

**Actor**: User with CREATE_PROJECT and VIEW_BOM permissions

**Flow**:

1. **Navigate to Projects â†’ New Project**
2. **Select creation method**:
   - â—‰ From Proposal (standard flow)
   - â—‰ From BOM (internal/direct)
   - â—‰ Blank Project (manual setup)

3. **If "From BOM" selected**:
   - Show BOM selection dialog (same as Proposal BOM import)
   - Select BOM
   - Enter project details (name, dates, PM)
   - System creates:
     - Project with BOM link
     - Budget line items (from BOM cost summary)
     - Procurement items (from BOM BUY items)
     - Document requirements (standard for BOM category)
     - Tasks (engineering, procurement, fabrication)

4. **Difference from Proposal flow**:
   - No proposal link
   - No client-specific deliverables
   - Budget based on BOM cost (no markup/margin)
   - Simplified document requirements

---

## 6. Technical Implementation

### 6.1 Service Layer Functions

**Location**: `/apps/web/src/lib/integration/`

```typescript
// bomProposalIntegration.ts
export async function importBOMToProposal(
  proposalId: string,
  bomId: string,
  options: BOMImportOptions
): Promise<{ lineItems: ProposalLineItem[]; summary: ImportSummary }>;

export async function syncBOMToProposal(
  proposalId: string,
  syncMode: 'REPLACE_ALL' | 'UPDATE_EXISTING' | 'SELECTIVE'
): Promise<void>;

export async function checkBOMSync(proposalId: string): Promise<{
  isOutOfSync: boolean;
  changes: BOMChange[];
}>;

// proposalProjectIntegration.ts
export async function createProjectFromProposal(
  proposalId: string,
  options: ProjectCreationOptions
): Promise<Project>;

export async function generateProcurementItems(
  projectId: string,
  bomId: string
): Promise<ProjectProcurementItem[]>;

export async function generateDocumentRequirements(
  projectId: string,
  projectType: string,
  bomCategory: BOMCategory
): Promise<DocumentRequirement[]>;

export async function generateProjectTasks(
  projectId: string,
  bomId: string,
  docRequirements: DocumentRequirement[]
): Promise<Task[]>;

// bomProjectIntegration.ts
export async function createProjectFromBOM(
  bomId: string,
  projectDetails: Partial<Project>
): Promise<Project>;
```

### 6.2 Firestore Security Rules

```javascript
// Proposal â†’ BOM link validation
match /proposals/{proposalId} {
  allow update: if request.resource.data.bomId != resource.data.bomId &&
                   get(/databases/$(database)/documents/boms/$(request.resource.data.bomId)).data.status in ['APPROVED', 'RELEASED'];
}

// Project creation from proposal
match /projects/{projectId} {
  allow create: if request.resource.data.proposalId != null &&
                   get(/databases/$(database)/documents/proposals/$(request.resource.data.proposalId)).data.status == 'ACCEPTED' &&
                   hasPermission(CREATE_PROJECT);
}

// Budget line items (locked if from proposal)
match /projects/{projectId}/budgetLineItems/{itemId} {
  allow update: if resource.data.locked == false ||
                   (resource.data.locked == true && hasPermission(MANAGE_BUDGET_OVERRIDE));
}
```

### 6.3 Cloud Functions

**Functions to create**:

1. **`onProposalAccepted`** (Firestore trigger):
   - Trigger: Proposal status â†’ ACCEPTED
   - Action: Show "Create Project" prompt
   - Optional: Auto-create project if setting enabled

2. **`onBOMUpdated`** (Firestore trigger):
   - Trigger: BOM updated
   - Action: Mark linked proposals as `bomOutOfSync = true`
   - Send notification to proposal owners

3. **`syncBOMToProposalScheduled`** (Scheduled function):
   - Frequency: Daily
   - Action: Check all proposals with `bomOutOfSync = true` and status = DRAFT
   - Send reminder emails

---

## 7. Success Metrics

### 7.1 Integration Efficiency

- **BOM â†’ Proposal Import Time**: < 10 seconds for 100-item BOM
- **Proposal â†’ Project Creation Time**: < 15 seconds (including all auto-generation)
- **Data Accuracy**: 100% of BOM costs transferred correctly
- **Manual Entry Reduction**: 80% reduction in manual data entry for project setup

### 7.2 User Adoption

- **BOM Usage in Proposals**: 70%+ of proposals use BOM import (after 2 months)
- **Auto-task Acceptance**: 60%+ of auto-generated tasks completed without modification
- **Project Creation Time**: Reduced from 2 hours (manual) to 15 minutes (automated)

### 7.3 Data Quality

- **Budget Accuracy**: Â±5% variance between proposal and actual project cost
- **Procurement Item Completeness**: 95%+ of procurement items auto-generated correctly
- **Document Completeness**: 90%+ of required documents identified automatically

---

## 8. Testing Requirements

### 8.1 Integration Test Scenarios

**Test 1: BOM â†’ Proposal â†’ Project (Full Flow)**

```
1. Create Material Database entries (5 materials)
2. Create Shape Database entries (8 shapes)
3. Create BOM (Heat Exchanger, 24 items)
4. Approve BOM
5. Create Proposal
6. Import BOM to Proposal (with 15% markup)
7. Verify all line items created correctly
8. Verify cost totals match (with markup)
9. Accept Proposal
10. Create Project from Proposal
11. Verify budget line items (4 items, totals match)
12. Verify procurement items (12 BUY items created)
13. Verify document requirements (8 docs created)
14. Verify tasks (15 tasks created, assigned correctly)
15. Verify notifications sent (5 users notified)
```

**Test 2: BOM Update Sync**

```
1. Link BOM to Proposal
2. Update BOM (change quantity, add item)
3. Verify Proposal.bomOutOfSync = true
4. Verify notification sent
5. Open Proposal, view changes
6. Sync BOM to Proposal
7. Verify updates reflected
8. Verify Proposal.bomOutOfSync = false
```

**Test 3: Direct BOM â†’ Project**

```
1. Create BOM (Pressure Vessel)
2. Create Project from BOM (no proposal)
3. Verify budget created from BOM costs (no markup)
4. Verify procurement items created
5. Verify engineering document requirements created
```

### 8.2 Performance Tests

- **Large BOM Import** (500 items): < 30 seconds
- **Project Creation** (with 200 procurement items): < 30 seconds
- **Concurrent Imports**: 5 users importing BOMs simultaneously

---

## 9. Implementation Phases

### Phase 1: BOM â†’ Proposal Integration (15-18 hours)

- [ ] Data model extensions (Proposal, ProposalLineItem)
- [ ] BOM import service function
- [ ] BOM selection dialog UI
- [ ] Item selection dialog UI
- [ ] Import configuration dialog UI
- [ ] Specification formatting logic
- [ ] Cost calculation with markup
- [ ] BOM sync detection
- [ ] BOM sync UI (diff view)
- [ ] Unit tests (10 tests)
- [ ] Integration tests (5 scenarios)

### Phase 2: Proposal â†’ Project Integration (12-15 hours)

- [ ] Data model extensions (Project, BudgetLineItem, ProjectProcurementItem, DocumentRequirement)
- [ ] Project creation service function
- [ ] Budget generation logic
- [ ] Procurement item generation logic
- [ ] Document requirement generation logic
- [ ] Task generation logic (rule-based)
- [ ] Notification service integration
- [ ] Create Project dialog UI
- [ ] Success summary UI
- [ ] Unit tests (8 tests)
- [ ] Integration tests (3 scenarios)

### Phase 3: Polish & Direct BOM Integration (3-5 hours)

- [ ] Direct BOM â†’ Project flow
- [ ] Error handling (BOM deleted, Proposal deleted)
- [ ] Audit trail (track all transfers)
- [ ] Performance optimization
- [ ] User documentation
- [ ] E2E test (full flow)

**Total Estimated Effort**: **30-40 hours** (1.5-2 weeks)

---

## 10. Future Enhancements (Post-v1.0)

### 10.1 Advanced Features

**BOM Versioning & Comparison**:

- Compare BOM v1 vs v2
- Show impact on proposal pricing
- Auto-create proposal revision if BOM changed significantly

**AI-Suggested Tasks**:

- Machine learning based on historical projects
- Suggest additional tasks based on project characteristics
- Predict task duration based on similar projects

**Resource Allocation**:

- Auto-assign users based on availability
- Load balancing across team members
- Skill-based assignment (assign CAD tasks to CAD operators)

**Cost Tracking Integration**:

- Real-time cost tracking (budget vs actual)
- Alert if procurement costs exceed BOM estimates by >10%
- Variance analysis reports

### 10.2 Workflow Automation

**Smart Milestones**:

- Auto-generate project milestones from proposal milestones
- Link tasks to milestones
- Track milestone completion percentage

**Document Templates**:

- Auto-populate document templates with BOM data
- Generate fabrication drawings from BOM shapes
- Auto-fill O&M manuals with equipment specifications

**Procurement Automation**:

- Auto-create Purchase Requests from procurement items
- Auto-send RFQs to preferred vendors
- Compare vendor quotes to BOM estimates

---

**End of Document**
