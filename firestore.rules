rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Check if user has specific permission (bitwise)
     * Permission flags are defined in packages/constants/src/permissions.ts
     * Note: Firestore rules don't support bitwise operators, so we use modulo arithmetic
     */
    function hasPermission(permissionBit) {
      return isAuthenticated() &&
             request.auth.token.permissions != null &&
             math.floor(request.auth.token.permissions / permissionBit) % 2 == 1;
    }

    /**
     * Check if user has MANAGE_USERS permission (permission bit 1)
     * This is the highest level admin permission
     */
    function isAdmin() {
      return hasPermission(1); // MANAGE_USERS
    }

    /**
     * Check if user is a Super Admin (highest privilege level)
     * Super Admins can perform destructive operations like deletes
     */
    function isSuperAdmin() {
      return isAuthenticated() &&
             request.auth.token.roles != null &&
             request.auth.token.roles.hasAny(['SUPER_ADMIN']);
    }

    /**
     * Check if user is from internal domain (@vapourdesal.com)
     */
    function isInternalUser() {
      return isAuthenticated() &&
             request.auth.token.domain == 'internal';
    }

    /**
     * Check if user is external
     */
    function isExternalUser() {
      return isAuthenticated() &&
             request.auth.token.domain == 'external';
    }

    /**
     * Check if user owns the resource
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /**
     * Check if user is assigned to project
     * PERFORMANCE FIX: Use custom claims instead of get() to avoid Firestore reads
     */
    function isAssignedToProject(projectId) {
      return isAuthenticated() &&
             request.auth.token.assignedProjects != null &&
             request.auth.token.assignedProjects.hasAny([projectId]);
    }

    // ============================================
    // Users Collection
    // ============================================

    match /users/{userId} {
      // Read: Users can read their own profile, or have MANAGE_USERS permission
      allow read: if isOwner(userId) ||
                     hasPermission(1); // MANAGE_USERS

      // Create: Users can create their own pending profile during first sign-in
      //         OR users with MANAGE_USERS permission can create any user
      allow create: if (isOwner(userId) &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.isActive == false &&
                       request.resource.data.permissions == 0) ||
                      (hasPermission(1) && isInternalUser()); // MANAGE_USERS

      // Update: Users can update their own preferences, or have MANAGE_USERS permission
      allow update: if (isOwner(userId) &&
                       request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['preferences', 'photoURL', 'lastLoginAt'])) ||
                      hasPermission(1); // MANAGE_USERS

      // Delete: Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================
    // Entities Collection (Vendors/Customers/Partners)
    // ============================================

    match /entities/{entityId} {
      // Read: Users with VIEW_ENTITIES permission (32)
      //       All internal users should have this permission
      allow read: if hasPermission(32) && // VIEW_ENTITIES
                     isInternalUser();

      // Create: Users with CREATE_ENTITIES permission (64)
      allow create: if hasPermission(64) && // CREATE_ENTITIES
                       isInternalUser();

      // Update: Users with EDIT_ENTITIES permission (128)
      allow update: if hasPermission(128) && // EDIT_ENTITIES
                       isInternalUser();

      // Delete: Users with DELETE_ENTITIES permission (256)
      //         Most sensitive operation - typically only managers/admins
      allow delete: if hasPermission(256) && // DELETE_ENTITIES
                       isInternalUser();
    }

    // ============================================
    // Projects Collection
    // ============================================

    match /projects/{projectId} {
      // Read: Internal users assigned to project OR have VIEW_PROJECTS permission
      //       External users (CLIENT_PM) assigned to project
      allow read: if (isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     )) ||
                     (isExternalUser() && isAssignedToProject(projectId));

      // Create: Only internal users with MANAGE_PROJECTS permission
      allow create: if hasPermission(8) && // MANAGE_PROJECTS
                       isInternalUser();

      // Update: Only internal users with MANAGE_PROJECTS permission
      allow update: if hasPermission(8) && // MANAGE_PROJECTS
                       isInternalUser();

      // Delete: Only admins
      allow delete: if isAdmin();

      // ============================================
      // Project Subcollections
      // ============================================

      // Time Stats (read-only aggregated data)
      match /time_stats/{statId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow write: if false; // Written by Cloud Functions only
      }

      // Procurement Stats (read by CLIENT_PM and internal users)
      match /procurement_stats/{statId} {
        allow read: if (isInternalUser() && (
                         isAssignedToProject(projectId) ||
                         hasPermission(16) // VIEW_PROJECTS
                       )) ||
                       (isExternalUser() && isAssignedToProject(projectId));
        allow write: if false; // Written by Cloud Functions only
      }
    }

    // ============================================
    // Time Entries Collection
    // ============================================

    match /timeEntries/{entryId} {
      // Read: Internal users - own entries OR have MANAGE_TIME_TRACKING permission
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission(4096) // MANAGE_TIME_TRACKING (bit 12)
                   );

      // Create: Internal users can create their own entries
      allow create: if isInternalUser() &&
                       isOwner(request.resource.data.userId) &&
                       isAssignedToProject(request.resource.data.projectId);

      // Update: Internal users - own entries (if not approved) OR have MANAGE_TIME_TRACKING
      allow update: if isInternalUser() && (
                       (isOwner(resource.data.userId) &&
                        resource.data.status != 'APPROVED') ||
                       hasPermission(4096) // MANAGE_TIME_TRACKING (bit 12)
                     );

      // Delete: Only users with MANAGE_TIME_TRACKING permission
      allow delete: if hasPermission(4096) && isInternalUser(); // MANAGE_TIME_TRACKING (bit 12)
    }

    // ============================================
    // Accounting Collections
    // ============================================

    match /accounts/{accountId} {
      // Chart of Accounts - Only internal users with accounting permissions
      allow read: if hasPermission(32768) && isInternalUser(); // VIEW_ACCOUNTING (bit 15)
      allow create: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow delete: if isSuperAdmin();
    }

    match /transactions/{transactionId} {
      // Unified transactions collection for all transaction types
      // Includes: CUSTOMER_INVOICE, VENDOR_BILL, JOURNAL_ENTRY, CUSTOMER_PAYMENT, VENDOR_PAYMENT
      allow read: if hasPermission(32768) && isInternalUser(); // VIEW_ACCOUNTING (bit 15)
      allow create: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow delete: if isSuperAdmin();
    }

    match /costCentres/{costCentreId} {
      // Cost Centres - Project-based cost tracking for accounting
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768) && isInternalUser(); // VIEW_ACCOUNTING (bit 15)

      // Create: Users with MANAGE_ACCOUNTING permission or system (Cloud Functions)
      // Cloud Functions auto-create cost centres when projects are created
      allow create: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)

      // Update: Users with MANAGE_ACCOUNTING permission
      // Cloud Functions can also update to sync with project changes
      allow update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Procurement Collections
    // ============================================

    match /purchaseRequests/{prId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /purchaseRequestItems/{itemId} {
      // Read: Same permissions as parent purchaseRequest
      allow read: if isInternalUser();

      // Write: Users with MANAGE_PROCUREMENT permission
      allow create, update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /rfqs/{rfqId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /purchaseOrders/{poId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /quotations/{quoteId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create, update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Estimation Collections
    // ============================================

    match /estimates/{estimateId} {
      // Only internal users with estimation permissions
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
      allow create: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
      allow delete: if isSuperAdmin();
    }

    match /costBreakdowns/{breakdownId} {
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
      allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Material Database Collections
    // ============================================

    match /materials/{materialId} {
      // Read: Only internal users with estimation permissions
      // Materials are used in estimation and engineering
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only (soft delete preferred)
      allow delete: if isSuperAdmin();

      // Material Variants Subcollection (ASME standards data)
      match /variants/{variantId} {
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
        allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
        allow delete: if isSuperAdmin();
      }

      // Material Prices Subcollection
      match /prices/{priceId} {
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
        allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
        allow delete: if isSuperAdmin();
      }

      // Stock Movements Subcollection
      match /stockMovements/{movementId} {
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
        allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
        allow delete: if isSuperAdmin();
      }
    }

    // ============================================
    // Company Settings
    // ============================================

    match /company/{docId} {
      // Read: All authenticated internal users
      allow read: if isInternalUser();

      // Write: Only users with MANAGE_COMPANY_SETTINGS permission
      allow write: if hasPermission(512) && isInternalUser(); // MANAGE_COMPANY_SETTINGS (bit 9)
    }

    // ============================================
    // Leave Requests
    // ============================================

    match /leaveRequests/{requestId} {
      // Read: Own requests OR have APPROVE_LEAVES permission
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission(512) // APPROVE_LEAVES
                   );

      // Create: Users can create their own leave requests
      allow create: if isInternalUser() &&
                       isOwner(request.resource.data.userId);

      // Update: Own requests (if not approved) OR have APPROVE_LEAVES
      allow update: if isInternalUser() && (
                       (isOwner(resource.data.userId) &&
                        resource.data.status == 'PENDING') ||
                       hasPermission(512) // APPROVE_LEAVES
                     );

      allow delete: if isSuperAdmin();
    }

    // ============================================
    // On-Duty Records
    // ============================================

    match /onDutyRecords/{recordId} {
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission(1024) // MANAGE_ON_DUTY
                   );

      allow create, update: if hasPermission(1024) && isInternalUser(); // MANAGE_ON_DUTY
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Audit Logs (read-only for most users)
    // ============================================

    match /auditLogs/{logId} {
      allow read: if isAdmin(); // Only users with MANAGE_USERS permission
      allow write: if false; // Written by Cloud Functions only
    }

    // ============================================
    // Invitations Collection (CLIENT_PM invites)
    // ============================================

    match /invitations/{invitationId} {
      // Read: User can read their own invitation (by email)
      // Admin can read all invitations with MANAGE_USERS permission
      allow read: if (isAuthenticated() &&
                      request.auth.token.email == resource.data.email) ||
                     (hasPermission(1) && isInternalUser()); // MANAGE_USERS

      // Create: Only internal users with MANAGE_USERS permission
      allow create: if hasPermission(1) && isInternalUser() &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.assignedProjects.size() > 0;

      // Update: User can accept their invitation OR admin can update
      allow update: if (isAuthenticated() &&
                       request.auth.token.email == resource.data.email &&
                       request.resource.data.status == 'accepted' &&
                       resource.data.status == 'pending') ||
                      (hasPermission(1) && isInternalUser());

      // Delete: Only admins can delete invitations
      allow delete: if hasPermission(1) && isInternalUser();
    }

    // ============================================
    // Notifications Collection (In-App Only)
    // ============================================

    match /notifications/{notificationId} {
      // Read: Users can only read their own notifications
      allow read: if isAuthenticated() &&
                     isOwner(resource.data.userId);

      // Create: Only Cloud Functions or users with MANAGE_USERS permission
      // In practice, most notifications are created by Cloud Functions
      allow create: if hasPermission(1) && isInternalUser(); // MANAGE_USERS

      // Update: Users can update their own notification status (mark as read/archived)
      // Only allowed to update status, readAt, and archivedAt fields
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.userId) &&
                       request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['status', 'readAt', 'archivedAt']);

      // Delete: Users can delete their own notifications OR admins
      allow delete: if (isAuthenticated() && isOwner(resource.data.userId)) ||
                       hasPermission(1); // MANAGE_USERS
    }

    // ============================================
    // Currency & Forex Collections
    // ============================================

    // Exchange Rates Collection
    match /exchangeRates/{rateId} {
      // Read: Users with VIEW_FINANCIAL_REPORTS permission
      allow read: if hasPermission(8388608); // VIEW_FINANCIAL_REPORTS

      // Create/Update: Only by Cloud Functions (system)
      // Cloud Functions set createdBy to 'system'
      allow create, update: if request.auth != null;

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // Forex Gain/Loss Collection
    match /forex_gain_loss/{entryId} {
      // Read: Users with VIEW_FINANCIAL_REPORTS permission
      allow read: if hasPermission(8388608); // VIEW_FINANCIAL_REPORTS

      // Create/Update: Only by Cloud Functions or internal users with CREATE_TRANSACTIONS
      allow create, update: if hasPermission(2097152) && isInternalUser(); // CREATE_TRANSACTIONS

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // Currency Configuration Collection
    match /currency_config/{configId} {
      // Read: Users with VIEW_FINANCIAL_REPORTS permission
      allow read: if hasPermission(8388608); // VIEW_FINANCIAL_REPORTS

      // Create/Update: Users with permission bit 64 (financial setup)
      allow create, update: if hasPermission(64) && isInternalUser();

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Customer Invoices (Accounting Module)
    // ============================================

    match /customerInvoices/{invoiceId} {
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768); // VIEW_ACCOUNTING

      // Create/Update: Users with MANAGE_ACCOUNTING permission
      allow create, update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Documents Collection
    // ============================================

    match /documents/{documentId} {
      // Read: All authenticated internal users
      allow read: if isInternalUser();

      // Create/Update: All authenticated internal users
      allow create, update: if isInternalUser();

      // Delete: Document owner or super admins
      allow delete: if (isAuthenticated() && isOwner(resource.data.createdBy)) ||
                       isSuperAdmin();
    }

    // ============================================
    // Tasks Collection
    // ============================================

    match /tasks/{taskId} {
      // Read: All authenticated internal users
      allow read: if isInternalUser();

      // Create/Update: All authenticated internal users
      allow create, update: if isInternalUser();

      // Delete: Task owner or super admins
      allow delete: if (isAuthenticated() && isOwner(resource.data.createdBy)) ||
                       isSuperAdmin();
    }

    // ============================================
    // Vendor Bills (Accounting Module)
    // ============================================

    match /vendorBills/{billId} {
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768); // VIEW_ACCOUNTING

      // Create/Update: Users with MANAGE_ACCOUNTING permission
      allow create, update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Bank Reconciliation (Accounting Module)
    // ============================================

    match /bankReconciliation/{recordId} {
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768); // VIEW_ACCOUNTING

      // Create/Update: Users with MANAGE_ACCOUNTING permission
      allow create, update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Module Integrations (Super Admin Only)
    // ============================================

    match /moduleIntegrations/{integrationId} {
      // Read: Only users with MANAGE_USERS permission (Super Admins)
      allow read: if isAdmin(); // MANAGE_USERS (bit 1)

      // Write: Only users with MANAGE_USERS permission
      allow create, update: if isAdmin(); // MANAGE_USERS (bit 1)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Bought-Out Items (Phase 2: Proposal Foundation)
    // ============================================

    match /bought_out_items/{itemId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Soft delete only (set isActive = false), MANAGE_ESTIMATION permission
      allow delete: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
    }

    // ============================================
    // Services Catalog (Phase 3: Proposal Foundation)
    // ============================================

    match /services/{serviceId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // Service Rates Subcollection (historical pricing data)
    match /serviceRates/{rateId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Cost Configurations (Phase 4: Proposal Foundation)
    // ============================================

    match /costConfigurations/{configId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // BOM (Bill of Materials) / Estimation - Week 1 Sprint
    // ============================================

    match /boms/{bomId} {
      // Helper function to check BOM access
      function canAccessBOM() {
        return isAuthenticated() &&
          (resource.data.entityId == request.auth.token.entityId || isSuperAdmin());
      }

      // Read: Users in same entity with VIEW_ESTIMATION permission or Super Admins
      allow read: if canAccessBOM() &&
        (hasPermission(524288) || isSuperAdmin()); // VIEW_ESTIMATION = 524288

      // Create: Authenticated users with VIEW_ESTIMATION permission in their entity
      allow create: if isAuthenticated() &&
        hasPermission(524288) && // VIEW_ESTIMATION
        request.resource.data.entityId == request.auth.token.entityId &&
        request.resource.data.createdBy == request.auth.uid;

      // Update: Owner or users with MANAGE_ESTIMATION permission in same entity
      // Week 1: Only DRAFT status allowed
      allow update: if canAccessBOM() &&
        (
          resource.data.createdBy == request.auth.uid || // Owner can edit
          hasPermission(1048576) // MANAGE_ESTIMATION = 1048576
        ) &&
        resource.data.status == 'DRAFT' && // Week 1: Only DRAFT can be edited
        request.resource.data.status == 'DRAFT'; // Week 1: Status stays DRAFT

      // Delete: Only creator or Super Admin
      allow delete: if canAccessBOM() &&
        (resource.data.createdBy == request.auth.uid || isSuperAdmin()) &&
        resource.data.status == 'DRAFT'; // Week 1: Only DRAFT can be deleted

      // BOM Items Subcollection
      match /items/{itemId} {
        // Read: Same as parent BOM
        allow read: if canAccessBOM() && hasPermission(524288);

        // Create: If user can update parent BOM
        allow create: if canAccessBOM() &&
          (
            get(/databases/$(database)/documents/boms/$(bomId)).data.createdBy == request.auth.uid ||
            hasPermission(1048576)
          ) &&
          request.resource.data.bomId == bomId &&
          request.resource.data.createdBy == request.auth.uid;

        // Update: If user can update parent BOM
        allow update: if canAccessBOM() &&
          (
            get(/databases/$(database)/documents/boms/$(bomId)).data.createdBy == request.auth.uid ||
            hasPermission(1048576)
          ) &&
          resource.data.bomId == bomId &&
          request.resource.data.bomId == bomId;

        // Delete: If user can update parent BOM
        allow delete: if canAccessBOM() &&
          (
            get(/databases/$(database)/documents/boms/$(bomId)).data.createdBy == request.auth.uid ||
            hasPermission(1048576)
          ) &&
          resource.data.bomId == bomId;
      }
    }

    // ============================================
    // Default: Deny all
    // ============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
