rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Check if user has specific permission (bitwise)
     * Permission flags are defined in packages/constants/src/permissions.ts
     * Note: Firestore rules don't support bitwise operators, so we use modulo arithmetic
     */
    function hasPermission(permissionBit) {
      return isAuthenticated() &&
             request.auth.token.permissions != null &&
             math.floor(request.auth.token.permissions / permissionBit) % 2 == 1;
    }

    /**
     * Check if user has MANAGE_USERS permission (permission bit 1)
     * This is the highest level admin permission
     */
    function isAdmin() {
      return hasPermission(1); // MANAGE_USERS
    }

    /**
     * Check if user has full admin permissions (highest privilege level)
     * Admins can perform destructive operations like deletes
     * Uses MANAGE_USERS permission (bit 0 = 1) as the admin indicator
     */
    function isSuperAdmin() {
      return isAuthenticated() && hasPermission(1); // MANAGE_USERS permission
    }

    /**
     * Check if user is from internal domain (@vapourdesal.com)
     */
    function isInternalUser() {
      return isAuthenticated() &&
             request.auth.token.domain == 'internal';
    }

    /**
     * Check if user is external
     */
    function isExternalUser() {
      return isAuthenticated() &&
             request.auth.token.domain == 'external';
    }

    /**
     * Check if user owns the resource
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /**
     * Check if user is assigned to project
     * PERFORMANCE FIX: Use custom claims instead of get() to avoid Firestore reads
     */
    function isAssignedToProject(projectId) {
      return isAuthenticated() &&
             request.auth.token.assignedProjects != null &&
             request.auth.token.assignedProjects.hasAny([projectId]);
    }

    /**
     * Check if user has permission from permissions2 field (extended permissions)
     * Used for HR, SSOT, Thermal, and other modules added after original permissions exhausted
     * Permission bits are defined in packages/constants/src/permissions.ts PERMISSION_FLAGS_2
     */
    function hasPermission2(permissionBit) {
      return isAuthenticated() &&
             request.auth.token.permissions2 != null &&
             math.floor(request.auth.token.permissions2 / permissionBit) % 2 == 1;
    }

    // ============================================
    // Users Collection
    // ============================================

    match /users/{userId} {
      // Read: Users can read their own profile, internal users can read other users (for selectors),
      //       or have MANAGE_USERS permission for full admin access
      // Internal users need to read other users for: ApproverSelector, user mentions, team views, etc.
      allow read: if isOwner(userId) ||
                     isInternalUser() ||
                     hasPermission(1); // MANAGE_USERS

      // Create: Users can create their own pending profile during first sign-in
      //         OR users with MANAGE_USERS permission can create any user
      allow create: if (isOwner(userId) &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.isActive == false &&
                       request.resource.data.permissions == 0) ||
                      (hasPermission(1) && isInternalUser()); // MANAGE_USERS

      // Update: Users can update their own preferences, or have MANAGE_USERS permission
      allow update: if (isOwner(userId) &&
                       request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['preferences', 'photoURL', 'lastLoginAt'])) ||
                      hasPermission(1); // MANAGE_USERS

      // Delete: Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================
    // Entities Collection (Vendors/Customers/Partners)
    // ============================================

    match /entities/{entityId} {
      // Read: Users with VIEW_ENTITIES permission (32)
      //       All internal users should have this permission
      allow read: if hasPermission(32) && // VIEW_ENTITIES
                     isInternalUser();

      // Create: Users with CREATE_ENTITIES permission (64)
      allow create: if hasPermission(64) && // CREATE_ENTITIES
                       isInternalUser();

      // Update: Users with EDIT_ENTITIES permission (128)
      allow update: if hasPermission(128) && // EDIT_ENTITIES
                       isInternalUser();

      // Delete: Users with DELETE_ENTITIES permission (256)
      //         Most sensitive operation - typically only managers/admins
      allow delete: if hasPermission(256) && // DELETE_ENTITIES
                       isInternalUser();
    }

    // ============================================
    // Projects Collection
    // ============================================

    match /projects/{projectId} {
      // Read: Internal users assigned to project OR have VIEW_PROJECTS permission
      //       External users (CLIENT_PM) assigned to project
      allow read: if (isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     )) ||
                     (isExternalUser() && isAssignedToProject(projectId));

      // Create: Only internal users with MANAGE_PROJECTS permission
      allow create: if hasPermission(8) && // MANAGE_PROJECTS
                       isInternalUser();

      // Update: Only internal users with MANAGE_PROJECTS permission
      allow update: if hasPermission(8) && // MANAGE_PROJECTS
                       isInternalUser();

      // Delete: Only admins
      allow delete: if isAdmin();

      // ============================================
      // Project Subcollections
      // ============================================

      // Time Stats (read-only aggregated data)
      match /time_stats/{statId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow write: if false; // Written by Cloud Functions only
      }

      // Procurement Stats (read by CLIENT_PM and internal users)
      match /procurement_stats/{statId} {
        allow read: if (isInternalUser() && (
                         isAssignedToProject(projectId) ||
                         hasPermission(16) // VIEW_PROJECTS
                       )) ||
                       (isExternalUser() && isAssignedToProject(projectId));
        allow write: if false; // Written by Cloud Functions only
      }

      // ============================================
      // SSOT Process Data Subcollections
      // ============================================

      // Process Streams (INPUT_DATA)
      match /streams/{streamId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow create, update: if isInternalUser() &&
                                 (isAssignedToProject(projectId) ||
                                  hasPermission(8)); // MANAGE_PROJECTS
        allow delete: if isSuperAdmin();
      }

      // Process Equipment
      match /equipment/{equipmentId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow create, update: if isInternalUser() &&
                                 (isAssignedToProject(projectId) ||
                                  hasPermission(8)); // MANAGE_PROJECTS
        allow delete: if isSuperAdmin();
      }

      // Process Lines
      match /lines/{lineId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow create, update: if isInternalUser() &&
                                 (isAssignedToProject(projectId) ||
                                  hasPermission(8)); // MANAGE_PROJECTS
        allow delete: if isSuperAdmin();
      }

      // Process Instruments
      match /instruments/{instrumentId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow create, update: if isInternalUser() &&
                                 (isAssignedToProject(projectId) ||
                                  hasPermission(8)); // MANAGE_PROJECTS
        allow delete: if isSuperAdmin();
      }

      // Process Valves
      match /valves/{valveId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow create, update: if isInternalUser() &&
                                 (isAssignedToProject(projectId) ||
                                  hasPermission(8)); // MANAGE_PROJECTS
        allow delete: if isSuperAdmin();
      }

      // Pipe Table (lookup table for pipe sizing)
      match /pipeTable/{pipeId} {
        allow read: if isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(16) // VIEW_PROJECTS
                     );
        allow create, update: if isInternalUser() &&
                                 (isAssignedToProject(projectId) ||
                                  hasPermission(8)); // MANAGE_PROJECTS
        allow delete: if isSuperAdmin();
      }
    }

    // ============================================
    // Task Notifications Collection (Flow Module)
    // ============================================

    match /taskNotifications/{notificationId} {
      // Read: Users can read their own task notifications
      //       (either as recipient via userId or as assignee via assigneeId)
      allow read: if isAuthenticated() &&
                     (isOwner(resource.data.userId) ||
                      isOwner(resource.data.assigneeId));

      // Create: Any authenticated user can create task notifications
      // Task notifications are created by app code as part of approval workflows
      // Security is enforced by app logic - only workflows can trigger task creation
      allow create: if isAuthenticated();

      // Update: Users can update their own notifications (mark read, complete, etc.)
      allow update: if isAuthenticated() &&
                       (isOwner(resource.data.userId) ||
                        isOwner(resource.data.assigneeId));

      // Delete: Only super admins
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Time Entries Collection
    // ============================================

    match /time_entries/{entryId} {
      // Read: Internal users - own entries OR have MANAGE_TIME_TRACKING permission
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission(4096) // MANAGE_TIME_TRACKING (bit 12)
                   );

      // Create: Internal users can create their own entries
      // Note: projectId may be optional for general time tracking
      allow create: if isInternalUser() &&
                       isOwner(request.resource.data.userId);

      // Update: Internal users - own entries (if not approved) OR have MANAGE_TIME_TRACKING
      allow update: if isInternalUser() && (
                       (isOwner(resource.data.userId) &&
                        resource.data.status != 'APPROVED') ||
                       hasPermission(4096) // MANAGE_TIME_TRACKING (bit 12)
                     );

      // Delete: Only users with MANAGE_TIME_TRACKING permission
      allow delete: if hasPermission(4096) && isInternalUser(); // MANAGE_TIME_TRACKING (bit 12)
    }

    // ============================================
    // Task Threads, Messages & Mentions (Phase C)
    // ============================================

    match /taskThreads/{threadId} {
      // Read: Internal users can read threads for tasks they have access to
      allow read: if isInternalUser();

      // Create: Internal users can create threads
      allow create: if isInternalUser();

      // Update: Internal users can update threads (e.g., update messageCount)
      allow update: if isInternalUser();

      // Delete: Only super admins
      allow delete: if isSuperAdmin();
    }

    match /taskMessages/{messageId} {
      // Read: Internal users can read messages
      allow read: if isInternalUser();

      // Create: Internal users can create messages
      allow create: if isInternalUser() &&
                       isOwner(request.resource.data.userId);

      // Update: Users can edit their own messages
      allow update: if isInternalUser() &&
                       isOwner(resource.data.userId);

      // Delete: Users can delete their own messages OR super admins
      allow delete: if (isInternalUser() && isOwner(resource.data.userId)) ||
                       isSuperAdmin();
    }

    match /taskMentions/{mentionId} {
      // Read: Users can read their own mentions
      allow read: if isAuthenticated() &&
                     isOwner(resource.data.mentionedUserId);

      // Create: Internal users can create mentions when sending messages
      allow create: if isInternalUser();

      // Update: Users can mark their own mentions as read
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.mentionedUserId) &&
                       request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['read']);

      // Delete: Only super admins
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Accounting Collections
    // ============================================

    match /accounts/{accountId} {
      // Chart of Accounts - Only internal users with accounting permissions
      allow read: if hasPermission(32768) && isInternalUser(); // VIEW_ACCOUNTING (bit 15)
      allow create: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow delete: if isSuperAdmin();
    }

    match /transactions/{transactionId} {
      // Unified transactions collection for all transaction types
      // Includes: CUSTOMER_INVOICE, VENDOR_BILL, JOURNAL_ENTRY, CUSTOMER_PAYMENT, VENDOR_PAYMENT
      allow read: if hasPermission(32768) && isInternalUser(); // VIEW_ACCOUNTING (bit 15)
      allow create: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)
      allow delete: if isSuperAdmin();
    }

    match /costCentres/{costCentreId} {
      // Cost Centres - Project-based cost tracking for accounting
      // Read: All internal users (needed for ProjectSelector, expense allocation, etc.)
      // Cost centres are organizational units, not sensitive financial data
      allow read: if isInternalUser();

      // Create: Users with MANAGE_ACCOUNTING permission or system (Cloud Functions)
      // Cloud Functions auto-create cost centres when projects are created
      allow create: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)

      // Update: Users with MANAGE_ACCOUNTING permission
      // Cloud Functions can also update to sync with project changes
      allow update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING (bit 14)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Procurement Collections
    // ============================================

    match /purchaseRequests/{prId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /purchaseRequestItems/{itemId} {
      // Read: Same permissions as parent purchaseRequest
      allow read: if isInternalUser();

      // Write: Users with MANAGE_PROCUREMENT permission
      allow create, update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)

      // Delete: Users with MANAGE_PROCUREMENT can delete items (e.g., during PR edit)
      // This is needed for the Edit PR page when removing line items
      allow delete: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
    }

    match /rfqs/{rfqId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /rfqItems/{itemId} {
      // RFQ line items - same permissions as parent RFQ
      // Read: Internal users (simplified - RFQ access implies item access)
      allow read: if isInternalUser();

      // Write: Users with MANAGE_PROCUREMENT permission
      allow create, update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /purchaseOrders/{poId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    match /quotations/{quoteId} {
      // Read: Internal users OR external CLIENT_PM for their projects
      allow read: if (isInternalUser()) ||
                     (isExternalUser() &&
                      hasPermission(131072) && // VIEW_PROCUREMENT (bit 17)
                      isAssignedToProject(resource.data.projectId));

      allow create, update: if hasPermission(65536) && isInternalUser(); // MANAGE_PROCUREMENT (bit 16)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Estimation Collections
    // ============================================

    match /estimates/{estimateId} {
      // Only internal users with estimation permissions
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
      allow create: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
      allow delete: if isSuperAdmin();
    }

    match /costBreakdowns/{breakdownId} {
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
      allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Material Database Collections
    // ============================================

    match /materials/{materialId} {
      // Read: Only internal users with estimation permissions
      // Materials are used in estimation and engineering
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only (soft delete preferred)
      allow delete: if isSuperAdmin();

      // Material Variants Subcollection (ASME standards data)
      match /variants/{variantId} {
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
        allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
        allow delete: if isSuperAdmin();
      }

      // Material Prices Subcollection
      match /prices/{priceId} {
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
        allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
        allow delete: if isSuperAdmin();
      }

      // Stock Movements Subcollection
      match /stockMovements/{movementId} {
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)
        allow create, update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
        allow delete: if isSuperAdmin();
      }
    }

    // ============================================
    // Company Settings
    // ============================================

    match /company/{docId} {
      // Read: All authenticated internal users
      allow read: if isInternalUser();

      // Write: Only users with MANAGE_COMPANY_SETTINGS permission
      allow write: if hasPermission(512) && isInternalUser(); // MANAGE_COMPANY_SETTINGS (bit 9)
    }

    // ============================================
    // Leave Requests
    // ============================================

    match /leaveRequests/{requestId} {
      // Read: Own requests OR have APPROVE_LEAVES permission
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission(512) // APPROVE_LEAVES
                   );

      // Create: Users can create their own leave requests
      allow create: if isInternalUser() &&
                       isOwner(request.resource.data.userId);

      // Update: Own requests (if not approved) OR have APPROVE_LEAVES
      allow update: if isInternalUser() && (
                       (isOwner(resource.data.userId) &&
                        resource.data.status == 'PENDING') ||
                       hasPermission(512) // APPROVE_LEAVES
                     );

      allow delete: if isSuperAdmin();
    }

    // ============================================
    // On-Duty Records
    // ============================================

    match /onDutyRecords/{recordId} {
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission(1024) // MANAGE_ON_DUTY
                   );

      allow create, update: if hasPermission(1024) && isInternalUser(); // MANAGE_ON_DUTY
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Audit Logs (read-only for most users)
    // ============================================

    match /auditLogs/{logId} {
      allow read: if isAdmin(); // Only users with MANAGE_USERS permission
      allow write: if false; // Written by Cloud Functions only
    }

    // ============================================
    // Invitations Collection (CLIENT_PM invites)
    // ============================================

    match /invitations/{invitationId} {
      // Read: User can read their own invitation (by email)
      // Admin can read all invitations with MANAGE_USERS permission
      allow read: if (isAuthenticated() &&
                      request.auth.token.email == resource.data.email) ||
                     (hasPermission(1) && isInternalUser()); // MANAGE_USERS

      // Create: Only internal users with MANAGE_USERS permission
      allow create: if hasPermission(1) && isInternalUser() &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.assignedProjects.size() > 0;

      // Update: User can accept their invitation OR admin can update
      allow update: if (isAuthenticated() &&
                       request.auth.token.email == resource.data.email &&
                       request.resource.data.status == 'accepted' &&
                       resource.data.status == 'pending') ||
                      (hasPermission(1) && isInternalUser());

      // Delete: Only admins can delete invitations
      allow delete: if hasPermission(1) && isInternalUser();
    }

    // ============================================
    // Notifications Collection (In-App Only)
    // ============================================

    match /notifications/{notificationId} {
      // Read: Users can only read their own notifications
      allow read: if isAuthenticated() &&
                     isOwner(resource.data.userId);

      // Create: Only Cloud Functions or users with MANAGE_USERS permission
      // In practice, most notifications are created by Cloud Functions
      allow create: if hasPermission(1) && isInternalUser(); // MANAGE_USERS

      // Update: Users can update their own notification status (mark as read/archived)
      // Only allowed to update status, readAt, and archivedAt fields
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.userId) &&
                       request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['status', 'readAt', 'archivedAt']);

      // Delete: Users can delete their own notifications OR admins
      allow delete: if (isAuthenticated() && isOwner(resource.data.userId)) ||
                       hasPermission(1); // MANAGE_USERS
    }

    // ============================================
    // Currency & Forex Collections
    // ============================================

    // Exchange Rates Collection
    match /exchangeRates/{rateId} {
      // Read: Users with VIEW_FINANCIAL_REPORTS permission
      allow read: if hasPermission(8388608); // VIEW_FINANCIAL_REPORTS

      // Create/Update: Only by Cloud Functions (system)
      // Cloud Functions set createdBy to 'system'
      allow create, update: if request.auth != null;

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // Forex Gain/Loss Collection
    match /forex_gain_loss/{entryId} {
      // Read: Users with VIEW_FINANCIAL_REPORTS permission
      allow read: if hasPermission(8388608); // VIEW_FINANCIAL_REPORTS

      // Create/Update: Only by Cloud Functions or internal users with CREATE_TRANSACTIONS
      allow create, update: if hasPermission(2097152) && isInternalUser(); // CREATE_TRANSACTIONS

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // Currency Configuration Collection
    match /currency_config/{configId} {
      // Read: Users with VIEW_FINANCIAL_REPORTS permission
      allow read: if hasPermission(8388608); // VIEW_FINANCIAL_REPORTS

      // Create/Update: Users with permission bit 64 (financial setup)
      allow create, update: if hasPermission(64) && isInternalUser();

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Customer Invoices (Accounting Module)
    // ============================================

    match /customerInvoices/{invoiceId} {
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768); // VIEW_ACCOUNTING

      // Create/Update: Users with MANAGE_ACCOUNTING permission
      allow create, update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Documents Collection
    // ============================================

    match /documents/{documentId} {
      // Read: All authenticated internal users
      allow read: if isInternalUser();

      // Create/Update: All authenticated internal users
      allow create, update: if isInternalUser();

      // Delete: Document owner or super admins
      allow delete: if (isAuthenticated() && isOwner(resource.data.createdBy)) ||
                       isSuperAdmin();
    }

    // ============================================
    // Tasks Collection
    // ============================================

    match /tasks/{taskId} {
      // Read: All authenticated internal users
      allow read: if isInternalUser();

      // Create/Update: All authenticated internal users
      allow create, update: if isInternalUser();

      // Delete: Task owner or super admins
      allow delete: if (isAuthenticated() && isOwner(resource.data.createdBy)) ||
                       isSuperAdmin();
    }

    // ============================================
    // Vendor Bills (Accounting Module)
    // ============================================

    match /vendorBills/{billId} {
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768); // VIEW_ACCOUNTING

      // Create/Update: Users with MANAGE_ACCOUNTING permission
      allow create, update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Bank Reconciliation (Accounting Module)
    // ============================================

    match /bankReconciliation/{recordId} {
      // Read: Users with VIEW_ACCOUNTING permission
      allow read: if hasPermission(32768); // VIEW_ACCOUNTING

      // Create/Update: Users with MANAGE_ACCOUNTING permission
      allow create, update: if hasPermission(16384) && isInternalUser(); // MANAGE_ACCOUNTING

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Module Integrations (Super Admin Only)
    // ============================================

    match /moduleIntegrations/{integrationId} {
      // Read: Only users with MANAGE_USERS permission (Super Admins)
      allow read: if isAdmin(); // MANAGE_USERS (bit 1)

      // Write: Only users with MANAGE_USERS permission
      allow create, update: if isAdmin(); // MANAGE_USERS (bit 1)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Bought-Out Items (Phase 2: Proposal Foundation)
    // ============================================

    match /bought_out_items/{itemId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Soft delete only (set isActive = false), MANAGE_ESTIMATION permission
      allow delete: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
    }

    // ============================================
    // Services Catalog (Phase 3: Proposal Foundation)
    // ============================================

    match /services/{serviceId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // Service Rates Subcollection (historical pricing data)
    match /serviceRates/{rateId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Cost Configurations (Phase 4: Proposal Foundation)
    // ============================================

    match /costConfigurations/{configId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Enquiries Collection (Proposal Module)
    // ============================================

    match /enquiries/{enquiryId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Soft delete only (update status to CANCELLED)
      allow delete: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)
    }

    // ============================================
    // Proposals Collection (Proposal Module)
    // ============================================

    match /proposals/{proposalId} {
      // Read: Users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION (bit 19)

      // Create: Users with MANAGE_ESTIMATION permission
      allow create: if hasPermission(262144) && isInternalUser() &&
                       request.resource.data.entityId == request.auth.token.entityId &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.status == 'DRAFT' &&
                       request.resource.data.revision >= 1; // MANAGE_ESTIMATION (bit 18)

      // Update: Users with MANAGE_ESTIMATION permission
      // Approval workflow: users with approval permissions can update approvalHistory
      allow update: if hasPermission(262144) && isInternalUser(); // MANAGE_ESTIMATION (bit 18)

      // Delete: Super admins only (proposals should not be deleted, use revisions)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // BOM (Bill of Materials) / Estimation - Week 1 Sprint
    // ============================================

    match /boms/{bomId} {
      // Read: Internal users with VIEW_ESTIMATION permission
      allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION = 524288

      // Create: Internal users with VIEW_ESTIMATION permission
      allow create: if isInternalUser() &&
        hasPermission(524288) && // VIEW_ESTIMATION
        request.resource.data.createdBy == request.auth.uid;

      // Update: Owner or users with MANAGE_ESTIMATION permission
      // Week 1: Only DRAFT status allowed
      allow update: if isInternalUser() &&
        (
          resource.data.createdBy == request.auth.uid || // Owner can edit
          hasPermission(262144) // MANAGE_ESTIMATION = 262144 (bit 18)
        ) &&
        resource.data.status == 'DRAFT'; // Week 1: Only DRAFT can be edited

      // Delete: Only creator or Super Admin
      allow delete: if isInternalUser() &&
        (resource.data.createdBy == request.auth.uid || isSuperAdmin()) &&
        resource.data.status == 'DRAFT'; // Week 1: Only DRAFT can be deleted

      // BOM Items Subcollection
      match /items/{itemId} {
        // Read: Internal users with VIEW_ESTIMATION permission
        allow read: if isInternalUser() && hasPermission(524288); // VIEW_ESTIMATION

        // Create: If user can update parent BOM
        allow create: if isInternalUser() &&
          (
            get(/databases/$(database)/documents/boms/$(bomId)).data.createdBy == request.auth.uid ||
            hasPermission(262144) // MANAGE_ESTIMATION
          ) &&
          request.resource.data.bomId == bomId &&
          request.resource.data.createdBy == request.auth.uid;

        // Update: If user can update parent BOM
        allow update: if isInternalUser() &&
          (
            get(/databases/$(database)/documents/boms/$(bomId)).data.createdBy == request.auth.uid ||
            hasPermission(262144) // MANAGE_ESTIMATION
          ) &&
          resource.data.bomId == bomId &&
          request.resource.data.bomId == bomId;

        // Delete: If user can update parent BOM
        allow delete: if isInternalUser() &&
          (
            get(/databases/$(database)/documents/boms/$(bomId)).data.createdBy == request.auth.uid ||
            hasPermission(262144) // MANAGE_ESTIMATION
          ) &&
          resource.data.bomId == bomId;
      }
    }

    // ============================================
    // Document Management Module
    // ============================================

    /**
     * Document Numbering Configuration (per project)
     */
    match /projects/{projectId}/documentNumberingConfig/{configId} {
      allow read: if isInternalUser() && isAssignedToProject(projectId);
      allow write: if isInternalUser() && hasPermission(134217728); // MANAGE_DOCUMENTS
    }

    /**
     * Master Documents (per project)
     * Permission bits (from @vapour/constants):
     *   MANAGE_DOCUMENTS = 134217728 (bit 27) - Create/edit master document list
     *   SUBMIT_DOCUMENTS = 268435456 (bit 28) - Submit documents for review
     *   REVIEW_DOCUMENTS = 536870912 (bit 29) - Client review/comment (external)
     *   APPROVE_DOCUMENTS = 1073741824 (bit 30) - Approve submissions
     */
    match /projects/{projectId}/masterDocuments/{masterDocId} {
      // Read: Internal users assigned to project OR with VIEW_ALL_PROJECTS permission
      //       OR external CLIENT_PM for CLIENT_VISIBLE docs
      allow read: if (isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(32) || // VIEW_ALL_PROJECTS
                       hasPermission(134217728) // MANAGE_DOCUMENTS
                     )) ||
                     (isExternalUser() && isAssignedToProject(projectId) &&
                      resource.data.visibility == 'CLIENT_VISIBLE' &&
                      hasPermission(536870912)); // REVIEW_DOCUMENTS (external client access)

      // Create: Internal users with MANAGE_DOCUMENTS permission
      // Note: isAssignedToProject check removed to allow bulk imports
      allow create: if isInternalUser() &&
                       hasPermission(134217728); // MANAGE_DOCUMENTS

      // Update: PM with MANAGE_DOCUMENTS OR assignees with SUBMIT_DOCUMENTS
      allow update: if isInternalUser() &&
                       (hasPermission(134217728) || // MANAGE_DOCUMENTS
                        (isAssignedToProject(projectId) &&
                         hasPermission(268435456) && // SUBMIT_DOCUMENTS
                         request.auth.uid in resource.data.assignedTo));

      // Delete: Only PM or Super Admin
      allow delete: if isInternalUser() &&
                       (hasPermission(134217728) || isSuperAdmin());
    }

    /**
     * Document Submissions (per project)
     */
    match /projects/{projectId}/documentSubmissions/{submissionId} {
      // Read: Internal users assigned OR with VIEW_ALL_PROJECTS OR MANAGE_DOCUMENTS
      //       OR external CLIENT_PM for CLIENT_VISIBLE master docs
      allow read: if (isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(32) || // VIEW_ALL_PROJECTS
                       hasPermission(134217728) // MANAGE_DOCUMENTS
                     )) ||
                     (isExternalUser() && isAssignedToProject(projectId) &&
                      hasPermission(536870912)); // REVIEW_DOCUMENTS (external client access)

      // Create: Internal users with SUBMIT_DOCUMENTS permission OR MANAGE_DOCUMENTS
      allow create: if isInternalUser() &&
                       (hasPermission(134217728) || // MANAGE_DOCUMENTS (bypass project check)
                        (isAssignedToProject(projectId) && hasPermission(268435456))); // SUBMIT_DOCUMENTS

      // Update: Internal users (for resolutions) OR external CLIENT_PM (for review)
      allow update: if (isInternalUser() &&
                        (hasPermission(134217728) || // MANAGE_DOCUMENTS
                         (isAssignedToProject(projectId) && hasPermission(268435456)))) || // SUBMIT_DOCUMENTS
                       (isExternalUser() && isAssignedToProject(projectId) &&
                        hasPermission(536870912)); // REVIEW_DOCUMENTS

      // Delete: Only Super Admin
      allow delete: if isSuperAdmin();
    }

    /**
     * Document Comments (per project)
     */
    match /projects/{projectId}/documentComments/{commentId} {
      // Read: Internal users assigned OR with VIEW_ALL_PROJECTS OR MANAGE_DOCUMENTS
      //       OR external CLIENT_PM
      allow read: if (isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(32) || // VIEW_ALL_PROJECTS
                       hasPermission(134217728) // MANAGE_DOCUMENTS
                     )) ||
                     (isExternalUser() && isAssignedToProject(projectId) &&
                      hasPermission(536870912)); // REVIEW_DOCUMENTS

      // Create: External CLIENT_PM (add comments) OR internal users (add/respond)
      allow create: if (isExternalUser() && isAssignedToProject(projectId) &&
                        hasPermission(536870912)) || // REVIEW_DOCUMENTS
                       (isInternalUser() &&
                        (hasPermission(134217728) || // MANAGE_DOCUMENTS (bypass)
                         (isAssignedToProject(projectId) && hasPermission(268435456)))); // SUBMIT_DOCUMENTS

      // Update: Internal users for resolutions OR external CLIENT_PM for acceptance
      allow update: if (isInternalUser() &&
                        (hasPermission(134217728) || // MANAGE_DOCUMENTS
                         (isAssignedToProject(projectId) &&
                          (hasPermission(268435456) || hasPermission(1073741824))))) || // SUBMIT or APPROVE
                       (isExternalUser() && isAssignedToProject(projectId) &&
                        hasPermission(536870912) && // REVIEW_DOCUMENTS
                        isOwner(resource.data.commentedBy)); // Can only update own comments

      // Delete: Only Super Admin
      allow delete: if isSuperAdmin();
    }

    /**
     * Comment Resolution Tables (per project)
     */
    match /projects/{projectId}/commentResolutionTables/{crtId} {
      // Read: Internal users assigned OR with VIEW_ALL_PROJECTS OR MANAGE_DOCUMENTS
      //       OR external CLIENT_PM
      allow read: if (isInternalUser() && (
                       isAssignedToProject(projectId) ||
                       hasPermission(32) || // VIEW_ALL_PROJECTS
                       hasPermission(134217728) // MANAGE_DOCUMENTS
                     )) ||
                     (isExternalUser() && isAssignedToProject(projectId) &&
                      hasPermission(536870912)); // REVIEW_DOCUMENTS (external client access)

      // Create: Internal users generating CRT
      allow create: if isInternalUser() &&
                       (hasPermission(134217728) || // MANAGE_DOCUMENTS (bypass)
                        (isAssignedToProject(projectId) && hasPermission(268435456))); // SUBMIT_DOCUMENTS

      // Update: Internal users (for export info)
      allow update: if isInternalUser() &&
                       (hasPermission(134217728) || // MANAGE_DOCUMENTS (bypass)
                        (isAssignedToProject(projectId) && hasPermission(268435456))); // SUBMIT_DOCUMENTS

      // Delete: Only Super Admin
      allow delete: if isSuperAdmin();
    }

    /**
     * Supply Items (per project)
     */
    match /projects/{projectId}/supplyItems/{supplyItemId} {
      // Read: Internal users assigned to project OR with VIEW_ALL_PROJECTS OR MANAGE_DOCUMENTS
      allow read: if isInternalUser() && (
                     isAssignedToProject(projectId) ||
                     hasPermission(32) || // VIEW_ALL_PROJECTS
                     hasPermission(134217728) // MANAGE_DOCUMENTS
                   );

      // Create/Update: Internal users with appropriate permissions
      allow create, update: if isInternalUser() &&
                               (hasPermission(134217728) || // MANAGE_DOCUMENTS (bypass)
                                (isAssignedToProject(projectId) && hasPermission(268435456))); // SUBMIT_DOCUMENTS

      // Delete: Only PM or Super Admin
      allow delete: if isInternalUser() &&
                       (hasPermission(134217728) || isSuperAdmin());
    }

    /**
     * Work Items (per project)
     */
    match /projects/{projectId}/workItems/{workItemId} {
      // Read: Internal users assigned to project OR with VIEW_ALL_PROJECTS OR MANAGE_DOCUMENTS
      allow read: if isInternalUser() && (
                     isAssignedToProject(projectId) ||
                     hasPermission(32) || // VIEW_ALL_PROJECTS
                     hasPermission(134217728) // MANAGE_DOCUMENTS
                   );

      // Create/Update: Internal users with appropriate permissions
      allow create, update: if isInternalUser() &&
                               (hasPermission(134217728) || // MANAGE_DOCUMENTS (bypass)
                                (isAssignedToProject(projectId) && hasPermission(268435456))); // SUBMIT_DOCUMENTS

      // Delete: Only PM or Super Admin
      allow delete: if isInternalUser() &&
                       (hasPermission(134217728) || isSuperAdmin());
    }

    /**
     * Document Templates (company-wide or project-specific)
     */
    match /documentTemplates/{templateId} {
      // Read: All internal users
      allow read: if isInternalUser();

      // Create: Users with MANAGE_DOCUMENTS permission
      allow create: if isInternalUser() &&
                       hasPermission(134217728); // MANAGE_DOCUMENTS

      // Update: Template creator OR users with MANAGE_DOCUMENTS
      allow update: if isInternalUser() &&
                       (isOwner(resource.data.createdBy) ||
                        hasPermission(134217728)); // MANAGE_DOCUMENTS

      // Delete: Only Super Admin
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // System Counters (for sequence generation)
    // ============================================

    match /counters/{counterId} {
      // Read: All authenticated users
      allow read: if isAuthenticated();

      // Write: All authenticated users (for incrementing counters)
      allow write: if isAuthenticated();
    }

    // ============================================
    // Feedback Collection (Bug Reports, Feature Requests)
    // ============================================

    match /feedback/{feedbackId} {
      // Read: Admins can read all, users can read their own
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);

      // Create: Any authenticated user can submit feedback
      // This allows all users (internal and external) to report bugs
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'new';

      // Update: Only admins can update feedback status
      allow update: if isAdmin();

      // Delete: Only super admins
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // HR Module Collections
    // ============================================

    /**
     * HR Leave Types - Configuration for leave categories
     * Permission bits (from @vapour/constants PERMISSION_FLAGS_2):
     *   VIEW_HR = 4096 (bit 12)
     *   MANAGE_HR_SETTINGS = 8192 (bit 13)
     *   APPROVE_LEAVES = 16384 (bit 14)
     *   MANAGE_HR_PROFILES = 32768 (bit 15)
     */
    match /hrLeaveTypes/{typeId} {
      // Read: All internal users (needed for leave request forms)
      allow read: if isInternalUser();

      // Create/Update: Only users with MANAGE_HR_SETTINGS permission
      allow create, update: if isInternalUser() && hasPermission2(8192); // MANAGE_HR_SETTINGS

      // Delete: Super admins only (prefer soft delete via isActive = false)
      allow delete: if isSuperAdmin();
    }

    /**
     * HR Leave Balances - Per-user leave balance tracking
     */
    match /hrLeaveBalances/{balanceId} {
      // Read: Own balances OR users with APPROVE_LEAVES (to see team balances)
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission2(16384) || // APPROVE_LEAVES
                     hasPermission2(8192)     // MANAGE_HR_SETTINGS
                   );

      // Create/Update: Only users with MANAGE_HR_SETTINGS
      // Balances are typically created by system when fiscal year starts
      allow create, update: if isInternalUser() && hasPermission2(8192); // MANAGE_HR_SETTINGS

      // Delete: Super admins only
      allow delete: if isSuperAdmin();
    }

    /**
     * HR Leave Requests - Leave applications with approval workflow
     */
    match /hrLeaveRequests/{requestId} {
      // Read: Own requests OR users with APPROVE_LEAVES permission
      allow read: if isInternalUser() && (
                     isOwner(resource.data.userId) ||
                     hasPermission2(16384) || // APPROVE_LEAVES
                     hasPermission2(8192)     // MANAGE_HR_SETTINGS
                   );

      // Create: Users can create their own leave requests
      allow create: if isInternalUser() &&
                       isOwner(request.resource.data.userId);

      // Update: Own requests (if DRAFT or PENDING_APPROVAL) OR users with APPROVE_LEAVES
      // Users can edit their own draft requests or cancel pending ones
      // Approvers can approve/reject pending requests
      allow update: if isInternalUser() && (
                       (isOwner(resource.data.userId) &&
                        resource.data.status in ['DRAFT', 'PENDING_APPROVAL']) ||
                       hasPermission2(16384) || // APPROVE_LEAVES
                       hasPermission2(8192)     // MANAGE_HR_SETTINGS
                     );

      // Delete: Super admins only (use status change to CANCELLED instead)
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // Default: Deny all
    // ============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
